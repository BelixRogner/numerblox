---

title: Postprocessing


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/05_postprocessing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_postprocessing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">load_ext</span> nb_black
<span class="o">%</span><span class="k">load_ext</span> lab_black
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="99e7d04d-1b9b-427d-a48f-a2fdf3cb9ca1"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#99e7d04d-1b9b-427d-a48f-a2fdf3cb9ca1');

            setTimeout(function() {
                var nbb_cell_id = 1;
                var nbb_unformatted_code = "%load_ext autoreload\n%autoreload 2\n%load_ext nb_black\n%load_ext lab_black";
                var nbb_formatted_code = "%load_ext autoreload\n%autoreload 2\n%load_ext nb_black\n%load_ext lab_black";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The postprocessing procedure is similar to preprocessing. Preprocessors manipulate and/or add <code>feature</code> columns, while postprocessors manipulate and/or add <code>prediction</code> columns.</p>
<p>Every Postprocessor should inherit from <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a>. A Postprocessor should take a <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> as input and output a <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> where one or more new prediction column(s) with prefix <code>prediction</code> are added or manipulated.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="0.-BasePostProcessor">0. BasePostProcessor<a class="anchor-link" href="#0.-BasePostProcessor"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some characteristics are particular to Postprocessors, but not suitable to put in the <code>Processor</code> base class.
This functionality is implemented in <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BasePostProcessor" class="doc_header"><code>class</code> <code>BasePostProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L23" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BasePostProcessor</code>(<strong><code>final_col_name</code></strong>:<code>str</code>) :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<p>Base class for postprocessing objects.
Postprocessors manipulate or introduce new prediction columns in a NumerFrame.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="f111d528-46ef-4553-8f13-6d0eef2b21d0"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f111d528-46ef-4553-8f13-6d0eef2b21d0');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "#export\nclass BasePostProcessor(BaseProcessor):\n    \"\"\"\n    Base class for postprocessing objects.\n    Postprocessors manipulate or introduce new prediction columns in a NumerFrame.\n    \"\"\"\n    def __init__(self, final_col_name: str):\n        super().__init__()\n        self.final_col_name = final_col_name\n        assert final_col_name.startswith(\"prediction\"), f\"final_col name should start with 'prediction'. Got {final_col_name}\"\n\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        ...";
                var nbb_formatted_code = "# export\nclass BasePostProcessor(BaseProcessor):\n    \"\"\"\n    Base class for postprocessing objects.\n    Postprocessors manipulate or introduce new prediction columns in a NumerFrame.\n    \"\"\"\n\n    def __init__(self, final_col_name: str):\n        super().__init__()\n        self.final_col_name = final_col_name\n        assert final_col_name.startswith(\n            \"prediction\"\n        ), f\"final_col name should start with 'prediction'. Got {final_col_name}\"\n\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        ...";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Common-postprocessing-steps">1. Common postprocessing steps<a class="anchor-link" href="#1.-Common-postprocessing-steps"> </a></h2><p>We invite the Numerai community to develop new postprocessors so that everyone can benefit from new insights and research.
This section implements commonly used postprocessing for Numerai.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.0.-Tournament-agnostic">1.0. Tournament agnostic<a class="anchor-link" href="#1.0.-Tournament-agnostic"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Postprocessing that works for both Numerai Classic and Numerai Signals.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.0.1.-Standardization">1.0.1. Standardization<a class="anchor-link" href="#1.0.1.-Standardization"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Standardizing is an essential step in order to reliably combine Numerai predictions. It is a default postprocessor for <a href="/numerai_blocks/modelpipeline.html#ModelPipeline"><code>ModelPipeline</code></a> (Section 6).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Standardizer" class="doc_header"><code>class</code> <code>Standardizer</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L38" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Standardizer</code>(<strong><code>cols</code></strong>:<code>list</code>=<em><code>None</code></em>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Uniform standardization of prediction columns.
All values should only contain values in the range [0...1].
:param cols: All prediction columns that should be standardized.
Use all prediction columns by default.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="407c5621-b50b-4c99-abe0-b8e2752b5574"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#407c5621-b50b-4c99-abe0-b8e2752b5574');

            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "# export\n@typechecked\nclass Standardizer(BasePostProcessor):\n    \"\"\"\n    Uniform standardization of prediction columns.\n    All values should only contain values in the range [0...1].\n    :param cols: All prediction columns that should be standardized.\n    Use all prediction columns by default.\n    \"\"\"\n    def __init__(self, cols: list = None):\n        super().__init__(final_col_name=\"prediction\")\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        cols = dataf.prediction_cols if not self.cols else self.cols\n        for col in cols:\n            assert dataf[col].between(0, 1).all(), f\"All values should only contain values between 0 and 1. Does not hold for '{col}'\"\n        dataf.loc[:, cols] = dataf.groupby(dataf.meta.era_col)[cols].rank(pct=True)\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\n@typechecked\nclass Standardizer(BasePostProcessor):\n    \"\"\"\n    Uniform standardization of prediction columns.\n    All values should only contain values in the range [0...1].\n    :param cols: All prediction columns that should be standardized.\n    Use all prediction columns by default.\n    \"\"\"\n\n    def __init__(self, cols: list = None):\n        super().__init__(final_col_name=\"prediction\")\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        cols = dataf.prediction_cols if not self.cols else self.cols\n        for col in cols:\n            assert (\n                dataf[col].between(0, 1).all()\n            ), f\"All values should only contain values between 0 and 1. Does not hold for '{col}'\"\n        dataf.loc[:, cols] = dataf.groupby(dataf.meta.era_col)[cols].rank(pct=True)\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_features</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prediction_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="s2">&quot;ABCDE&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">test_features</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;era&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">NumerFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="4daa87f1-73b3-4f57-ab17-b56ac61b84ae"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#4daa87f1-73b3-4f57-ab17-b56ac61b84ae');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "# Random DataFrame\ntest_features = [f\"prediction_{l}\" for l in \"ABCDE\"]\ndf = pd.DataFrame(np.random.uniform(size=(100, 5)), columns=test_features)\ndf[\"target\"] = np.random.normal(size=100)\ndf[\"era\"] = [0, 1, 2, 3] * 25\ntest_dataset = NumerFrame(df)";
                var nbb_formatted_code = "# Random DataFrame\ntest_features = [f\"prediction_{l}\" for l in \"ABCDE\"]\ndf = pd.DataFrame(np.random.uniform(size=(100, 5)), columns=test_features)\ndf[\"target\"] = np.random.normal(size=100)\ndf[\"era\"] = [0, 1, 2, 3] * 25\ntest_dataset = NumerFrame(df)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">std</span> <span class="o">=</span> <span class="n">Standardizer</span><span class="p">()</span>
<span class="n">std</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">get_prediction_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">Standardizer</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">)</span>. Time taken for step: <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">037877</span>. ✅
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction_A</th>
      <th>prediction_B</th>
      <th>prediction_C</th>
      <th>prediction_D</th>
      <th>prediction_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.16</td>
      <td>0.72</td>
      <td>0.96</td>
      <td>0.36</td>
      <td>0.28</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.00</td>
      <td>0.52</td>
      <td>0.08</td>
      <td>0.12</td>
      <td>0.04</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="f7465eb6-4a47-4563-8b64-0c9ce0298d41"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f7465eb6-4a47-4563-8b64-0c9ce0298d41');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "std = Standardizer()\nstd.transform(test_dataset).get_prediction_data.head(2)";
                var nbb_formatted_code = "std = Standardizer()\nstd.transform(test_dataset).get_prediction_data.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.0.2.-Ensembling">1.0.2. Ensembling<a class="anchor-link" href="#1.0.2.-Ensembling"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Multiple prediction results can be ensembled in multiple ways, but we provide the most common use cases here.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.0.2.1.-Simple-Mean">1.0.2.1. Simple Mean<a class="anchor-link" href="#1.0.2.1.-Simple-Mean"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MeanEnsembler" class="doc_header"><code>class</code> <code>MeanEnsembler</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L59" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MeanEnsembler</code>(<strong><code>cols</code></strong>:<code>list</code>, <strong><code>final_col_name</code></strong>:<code>str</code>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Take simple mean of multiple cols and store in new col.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="a794700c-11f8-4e68-8721-5483f03519b3"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#a794700c-11f8-4e68-8721-5483f03519b3');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "#export\n@typechecked\nclass MeanEnsembler(BasePostProcessor):\n    \"\"\" Take simple mean of multiple cols and store in new col. \"\"\"\n    def __init__(self, cols: list, final_col_name: str):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: Union[pd.DataFrame, NumerFrame]) -> NumerFrame:\n        dataf.loc[:, self.final_col_name] = dataf.loc[:, self.cols].mean(axis=1)\n        rich_print(f\":stew: Ensembled [blue]'{self.cols}'[blue] with simple mean and saved in [bold]'{self.final_col_name}'[bold] :stew:\")\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\n@typechecked\nclass MeanEnsembler(BasePostProcessor):\n    \"\"\"Take simple mean of multiple cols and store in new col.\"\"\"\n\n    def __init__(self, cols: list, final_col_name: str):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: Union[pd.DataFrame, NumerFrame]) -> NumerFrame:\n        dataf.loc[:, self.final_col_name] = dataf.loc[:, self.cols].mean(axis=1)\n        rich_print(\n            f\":stew: Ensembled [blue]'{self.cols}'[blue] with simple mean and saved in [bold]'{self.final_col_name}'[bold] :stew:\"\n        )\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.0.2.2.-Donate's-formula">1.0.2.2. Donate's formula<a class="anchor-link" href="#1.0.2.2.-Donate's-formula"> </a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This method for weighted averaging is mostly suitable if you have multiple models trained on a time series cross validation scheme. The first models will be trained on less data so we want to give them a lower weighting compared to the later models.</p>
<p>Source: <a href="https://www.kaggle.com/gogo827jz/jane-street-supervised-autoencoder-mlp">Yirun Zhang in his winning solution for the Jane Street 2021 Kaggle competition</a>.
Based on a <a href="https://doi.org/10.1016/j.neucom.2012.02.053">paper by Donate et al.</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DonateWeightedEnsembler" class="doc_header"><code>class</code> <code>DonateWeightedEnsembler</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L73" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DonateWeightedEnsembler</code>(<strong><code>final_col_name</code></strong>:<code>str</code>, <strong><code>cols</code></strong>:<code>list</code>=<em><code>None</code></em>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Weighted average as per Donate et al.'s formula
Paper Link: <a href="https://doi.org/10.1016/j.neucom.2012.02.053">https://doi.org/10.1016/j.neucom.2012.02.053</a>
Code source: <a href="https://www.kaggle.com/gogo827jz/jane-street-supervised-autoencoder-mlp">https://www.kaggle.com/gogo827jz/jane-street-supervised-autoencoder-mlp</a></p>
<p>Weightings for 5 folds: [0.0625, 0.0625, 0.125, 0.25, 0.5]</p>
<p>:param cols: Prediction columns to ensemble.
Uses all prediction columns by default.
:param final_col_name: New column name for ensembled values.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="5804afd4-dd43-478e-98b3-dd14f68cdd48"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#5804afd4-dd43-478e-98b3-dd14f68cdd48');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "#export\n@typechecked\nclass DonateWeightedEnsembler(BasePostProcessor):\n    \"\"\"\n    Weighted average as per Donate et al.'s formula\n    Paper Link: https://doi.org/10.1016/j.neucom.2012.02.053\n    Code source: https://www.kaggle.com/gogo827jz/jane-street-supervised-autoencoder-mlp\n\n    Weightings for 5 folds: [0.0625, 0.0625, 0.125, 0.25, 0.5]\n\n    :param cols: Prediction columns to ensemble.\n    Uses all prediction columns by default.\n    :param final_col_name: New column name for ensembled values.\n    \"\"\"\n    def __init__(self, final_col_name: str, cols: list = None):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n        self.n_cols = len(cols)\n        self.weights = self._get_weights()\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        cols = self.cols if self.cols else dataf.prediction_cols\n        dataf.loc[:, self.final_col_name] = np.average(dataf.loc[:, cols],\n                                                       weights=self.weights, axis=1)\n        rich_print(f\":stew: Ensembled [blue]'{cols}'[/blue] with [bold]{self.__class__.__name__}[/bold] and saved in [bold]'{self.final_col_name}'[bold] :stew:\")\n        return NumerFrame(dataf)\n\n    def _get_weights(self) -> list:\n        \"\"\"  Exponential weights. \"\"\"\n        weights = []\n        for j in range(1, self.n_cols+1):\n            j = 2 if j == 1 else j\n            weights.append(1 / (2**(self.n_cols + 1 - j)))\n        return weights";
                var nbb_formatted_code = "# export\n@typechecked\nclass DonateWeightedEnsembler(BasePostProcessor):\n    \"\"\"\n    Weighted average as per Donate et al.'s formula\n    Paper Link: https://doi.org/10.1016/j.neucom.2012.02.053\n    Code source: https://www.kaggle.com/gogo827jz/jane-street-supervised-autoencoder-mlp\n\n    Weightings for 5 folds: [0.0625, 0.0625, 0.125, 0.25, 0.5]\n\n    :param cols: Prediction columns to ensemble.\n    Uses all prediction columns by default.\n    :param final_col_name: New column name for ensembled values.\n    \"\"\"\n\n    def __init__(self, final_col_name: str, cols: list = None):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n        self.n_cols = len(cols)\n        self.weights = self._get_weights()\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        cols = self.cols if self.cols else dataf.prediction_cols\n        dataf.loc[:, self.final_col_name] = np.average(\n            dataf.loc[:, cols], weights=self.weights, axis=1\n        )\n        rich_print(\n            f\":stew: Ensembled [blue]'{cols}'[/blue] with [bold]{self.__class__.__name__}[/bold] and saved in [bold]'{self.final_col_name}'[bold] :stew:\"\n        )\n        return NumerFrame(dataf)\n\n    def _get_weights(self) -> list:\n        \"\"\"Exponential weights.\"\"\"\n        weights = []\n        for j in range(1, self.n_cols + 1):\n            j = 2 if j == 1 else j\n            weights.append(1 / (2 ** (self.n_cols + 1 - j)))\n        return weights";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_features</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prediction_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="s2">&quot;ABCDE&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">test_features</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;era&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">NumerFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="188e29e2-3da2-4e42-b194-9df598dc2bbe"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#188e29e2-3da2-4e42-b194-9df598dc2bbe');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "# Random DataFrame\ntest_features = [f\"prediction_{l}\" for l in \"ABCDE\"]\ndf = pd.DataFrame(np.random.uniform(size=(100, 5)), columns=test_features)\ndf[\"target\"] = np.random.normal(size=100)\ndf[\"era\"] = range(100)\ntest_dataset = NumerFrame(df)";
                var nbb_formatted_code = "# Random DataFrame\ntest_features = [f\"prediction_{l}\" for l in \"ABCDE\"]\ndf = pd.DataFrame(np.random.uniform(size=(100, 5)), columns=test_features)\ndf[\"target\"] = np.random.normal(size=100)\ndf[\"era\"] = range(100)\ntest_dataset = NumerFrame(df)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w_5_fold</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0625</span><span class="p">,</span> <span class="mf">0.0625</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="n">donate</span> <span class="o">=</span> <span class="n">DonateWeightedEnsembler</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">prediction_cols</span><span class="p">,</span> <span class="n">final_col_name</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
<span class="n">ensembled</span> <span class="o">=</span> <span class="n">donate</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">get_prediction_data</span>
<span class="k">assert</span> <span class="n">ensembled</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">w</span> <span class="o">*</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">w_5_fold</span><span class="p">,</span> <span class="n">ensembled</span><span class="p">[</span><span class="n">test_features</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
<span class="n">ensembled</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">🍲 Ensembled <span style="color: #000080; text-decoration-color: #000080">'['</span><span style="color: #000080; text-decoration-color: #000080">prediction_A', </span><span style="color: #000080; text-decoration-color: #000080">'prediction_B'</span><span style="color: #000080; text-decoration-color: #000080">, </span><span style="color: #000080; text-decoration-color: #000080">'prediction_C'</span><span style="color: #000080; text-decoration-color: #000080">, </span><span style="color: #000080; text-decoration-color: #000080">'prediction_D'</span><span style="color: #000080; text-decoration-color: #000080">, </span>
<span style="color: #000080; text-decoration-color: #000080">'prediction_E'</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">]</span><span style="color: #000080; text-decoration-color: #000080">'</span><span style="color: #008000; text-decoration-color: #008000"> with </span><span style="color: #008000; text-decoration-color: #008000; font-weight: bold">DonateWeightedEnsembler</span><span style="color: #008000; text-decoration-color: #008000"> and saved in </span><span style="color: #008000; text-decoration-color: #008000; font-weight: bold">'</span><span style="font-weight: bold">prediction' 🍲</span>
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">DonateWeightedEnsembler</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">016195</span>. ✅
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction_A</th>
      <th>prediction_B</th>
      <th>prediction_C</th>
      <th>prediction_D</th>
      <th>prediction_E</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.567128</td>
      <td>0.587369</td>
      <td>0.049798</td>
      <td>0.474388</td>
      <td>0.945412</td>
      <td>0.669684</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.117472</td>
      <td>0.216896</td>
      <td>0.741702</td>
      <td>0.356148</td>
      <td>0.581667</td>
      <td>0.493481</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="313c6764-02f9-45e1-a8c3-f72909178a2a"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#313c6764-02f9-45e1-a8c3-f72909178a2a');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "# [0.0625, 0.0625, 0.125, 0.25, 0.5] for 5 fold\nw_5_fold = [0.0625, 0.0625, 0.125, 0.25, 0.5]\ndonate = DonateWeightedEnsembler(cols=test_dataset.prediction_cols, final_col_name='prediction')\nensembled = donate(test_dataset).get_prediction_data\nassert ensembled['prediction'][0] == np.sum([w * elem for w, elem in zip(w_5_fold, ensembled[test_features].iloc[0])])\nensembled.head(2)";
                var nbb_formatted_code = "# [0.0625, 0.0625, 0.125, 0.25, 0.5] for 5 fold\nw_5_fold = [0.0625, 0.0625, 0.125, 0.25, 0.5]\ndonate = DonateWeightedEnsembler(\n    cols=test_dataset.prediction_cols, final_col_name=\"prediction\"\n)\nensembled = donate(test_dataset).get_prediction_data\nassert ensembled[\"prediction\"][0] == np.sum(\n    [w * elem for w, elem in zip(w_5_fold, ensembled[test_features].iloc[0])]\n)\nensembled.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.0.2.3.-Geometric-Mean">1.0.2.3. Geometric Mean<a class="anchor-link" href="#1.0.2.3.-Geometric-Mean"> </a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Take the mean of multiple prediction columns using the product of values.</p>
<p><strong>More info on Geometric mean:</strong>
<a href="https://en.wikipedia.org/wiki/Geometric_mean">Wikipedia</a>
<a href="https://www.investopedia.com/terms/g/geometricmean.asp">Investopedia</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GeometricMeanEnsembler" class="doc_header"><code>class</code> <code>GeometricMeanEnsembler</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L109" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GeometricMeanEnsembler</code>(<strong><code>final_col_name</code></strong>:<code>str</code>, <strong><code>cols</code></strong>:<code>list</code>=<em><code>None</code></em>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Calculate the weighted Geometric mean.
:param cols: Prediction columns to ensemble.
Uses all prediction columns by default.
:param final_col_name: New column name for ensembled values.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="cc8a7c7e-3d26-48bf-ab86-541770a1c2ee"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#cc8a7c7e-3d26-48bf-ab86-541770a1c2ee');

            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "#export\n@typechecked\nclass GeometricMeanEnsembler(BasePostProcessor):\n    \"\"\"\n    Calculate the weighted Geometric mean.\n    :param cols: Prediction columns to ensemble.\n    Uses all prediction columns by default.\n    :param final_col_name: New column name for ensembled values.\n    \"\"\"\n    def __init__(self, final_col_name: str, cols: list = None):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        cols = self.cols if self.cols else dataf.prediction_cols\n        new_col = dataf.loc[:, cols].apply(gmean, axis=1)\n        dataf.loc[:, self.final_col_name] = new_col\n        rich_print(f\":stew: Ensembled [blue]'{cols}'[/blue] with [bold]{self.__class__.__name__}[/bold] and saved in [bold]'{self.final_col_name}'[bold] :stew:\")\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\n@typechecked\nclass GeometricMeanEnsembler(BasePostProcessor):\n    \"\"\"\n    Calculate the weighted Geometric mean.\n    :param cols: Prediction columns to ensemble.\n    Uses all prediction columns by default.\n    :param final_col_name: New column name for ensembled values.\n    \"\"\"\n\n    def __init__(self, final_col_name: str, cols: list = None):\n        super().__init__(final_col_name=final_col_name)\n        self.cols = cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        cols = self.cols if self.cols else dataf.prediction_cols\n        new_col = dataf.loc[:, cols].apply(gmean, axis=1)\n        dataf.loc[:, self.final_col_name] = new_col\n        rich_print(\n            f\":stew: Ensembled [blue]'{cols}'[/blue] with [bold]{self.__class__.__name__}[/bold] and saved in [bold]'{self.final_col_name}'[bold] :stew:\"\n        )\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">geo_mean</span> <span class="o">=</span> <span class="n">GeometricMeanEnsembler</span><span class="p">(</span><span class="n">final_col_name</span><span class="o">=</span><span class="s1">&#39;prediction_geo&#39;</span><span class="p">)</span>
<span class="n">ensembled</span> <span class="o">=</span> <span class="n">geo_mean</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">get_prediction_data</span>
<span class="n">ensembled</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">🍲 Ensembled <span style="color: #000080; text-decoration-color: #000080">'['</span><span style="color: #000080; text-decoration-color: #000080">prediction_A', </span><span style="color: #000080; text-decoration-color: #000080">'prediction_B'</span><span style="color: #000080; text-decoration-color: #000080">, </span><span style="color: #000080; text-decoration-color: #000080">'prediction_C'</span><span style="color: #000080; text-decoration-color: #000080">, </span><span style="color: #000080; text-decoration-color: #000080">'prediction_D'</span><span style="color: #000080; text-decoration-color: #000080">, </span>
<span style="color: #000080; text-decoration-color: #000080">'prediction_E'</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">]</span><span style="color: #000080; text-decoration-color: #000080">'</span><span style="color: #008000; text-decoration-color: #008000"> with </span><span style="color: #008000; text-decoration-color: #008000; font-weight: bold">GeometricMeanEnsembler</span><span style="color: #008000; text-decoration-color: #008000"> and saved in </span><span style="color: #008000; text-decoration-color: #008000; font-weight: bold">'</span><span style="font-weight: bold">prediction_geo' 🍲</span>
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">GeometricMeanEnsembler</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">023425</span>. ✅
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction_A</th>
      <th>prediction_B</th>
      <th>prediction_C</th>
      <th>prediction_D</th>
      <th>prediction_E</th>
      <th>prediction</th>
      <th>prediction_geo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.567128</td>
      <td>0.587369</td>
      <td>0.049798</td>
      <td>0.474388</td>
      <td>0.945412</td>
      <td>0.669684</td>
      <td>0.375242</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.117472</td>
      <td>0.216896</td>
      <td>0.741702</td>
      <td>0.356148</td>
      <td>0.581667</td>
      <td>0.493481</td>
      <td>0.330023</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="e2347f7a-5bd3-4f56-b9ec-8e48aa1a0aa9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e2347f7a-5bd3-4f56-b9ec-8e48aa1a0aa9');

            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "geo_mean = GeometricMeanEnsembler(final_col_name='prediction_geo')\nensembled = geo_mean(test_dataset).get_prediction_data\nensembled.head(2)";
                var nbb_formatted_code = "geo_mean = GeometricMeanEnsembler(final_col_name=\"prediction_geo\")\nensembled = geo_mean(test_dataset).get_prediction_data\nensembled.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.0.3.-Neutralization-and-penalization">1.0.3. Neutralization and penalization<a class="anchor-link" href="#1.0.3.-Neutralization-and-penalization"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.0.3.1.-Feature-Neutralization">1.0.3.1. Feature Neutralization<a class="anchor-link" href="#1.0.3.1.-Feature-Neutralization"> </a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Classic feature neutralization (subtracting linear model from scores).</p>
<p>New column name for neutralized values will be <code>{PRED_NAME}_neutralized_{PROPORTION}</code>. <code>PRED_NAME</code> should start with <code>'prediction'</code>.</p>
<p><a href="https://www.kaggle.com/code1110/janestreet-avoid-overfit-feature-neutralization">Detailed explanation of Feature Neutralization by Katsu1110</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FeatureNeutralizer" class="doc_header"><code>class</code> <code>FeatureNeutralizer</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L130" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FeatureNeutralizer</code>(<strong><code>feature_names</code></strong>:<code>list</code>=<em><code>None</code></em>, <strong><code>pred_name</code></strong>:<code>str</code>=<em><code>'prediction'</code></em>, <strong><code>proportion</code></strong>:<code>float</code>=<em><code>0.5</code></em>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Classic feature neutralization by subtracting linear model.
:param feature_names: List of column names to neutralize against.
Uses all feature columns by default.
:param pred_name: Prediction column to neutralize.
:param proportion: Number in range [0...1] indicating how much to neutralize.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="d31c2ddb-a90b-41d1-b8bd-df63735e9c87"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d31c2ddb-a90b-41d1-b8bd-df63735e9c87');

            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "#export\n@typechecked\nclass FeatureNeutralizer(BasePostProcessor):\n    \"\"\"\n    Classic feature neutralization by subtracting linear model.\n    :param feature_names: List of column names to neutralize against.\n    Uses all feature columns by default.\n    :param pred_name: Prediction column to neutralize.\n    :param proportion: Number in range [0...1] indicating how much to neutralize.\n    \"\"\"\n    def __init__(self,\n                 feature_names: list = None,\n                 pred_name: str = \"prediction\",\n                 proportion: float = 0.5):\n        self.pred_name = pred_name\n        self.proportion = proportion\n        assert 0. <= proportion <= 1., f\"'proportion' should be a float in range [0...1]. Got '{proportion}'.\"\n        self.new_col_name = f\"{self.pred_name}_neutralized_{self.proportion}\"\n        super().__init__(final_col_name=self.new_col_name)\n\n        self.feature_names = feature_names\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        feature_names = self.feature_names if self.feature_names else dataf.feature_cols\n        neutralized_preds = dataf.groupby(dataf.meta.era_col)\\\n            .apply(lambda x: self.normalize_and_neutralize(x, [self.pred_name], feature_names))\n        dataf.loc[:, self.new_col_name] = MinMaxScaler().fit_transform(neutralized_preds)\n        rich_print(f\":robot: Neutralized [bold blue]'{self.pred_name}'[bold blue] with proportion [bold]'{self.proportion}'[/bold] :robot:\")\n        rich_print(f\"New neutralized column = [bold green]'{self.new_col_name}'[/bold green].\")\n        return NumerFrame(dataf)\n\n    def neutralize(self, dataf: pd.DataFrame, columns: list, by: list) -> pd.DataFrame:\n        scores = dataf[columns]\n        exposures = dataf[by].values\n        scores = scores - self.proportion * exposures.dot(np.linalg.pinv(exposures).dot(scores))\n        return scores / scores.std()\n\n    @staticmethod\n    def normalize(dataf: pd.DataFrame) -> np.ndarray:\n        normalized_ranks = (dataf.rank(method=\"first\") - 0.5) / len(dataf)\n        return sp.norm.ppf(normalized_ranks)\n\n    def normalize_and_neutralize(self, dataf: pd.DataFrame, columns: list, by: list) -> pd.DataFrame:\n        # Convert the scores to a normal distribution\n        dataf[columns] = self.normalize(dataf[columns])\n        dataf[columns] = self.neutralize(dataf, columns, by)\n        return dataf[columns]";
                var nbb_formatted_code = "# export\n@typechecked\nclass FeatureNeutralizer(BasePostProcessor):\n    \"\"\"\n    Classic feature neutralization by subtracting linear model.\n    :param feature_names: List of column names to neutralize against.\n    Uses all feature columns by default.\n    :param pred_name: Prediction column to neutralize.\n    :param proportion: Number in range [0...1] indicating how much to neutralize.\n    \"\"\"\n\n    def __init__(\n        self,\n        feature_names: list = None,\n        pred_name: str = \"prediction\",\n        proportion: float = 0.5,\n    ):\n        self.pred_name = pred_name\n        self.proportion = proportion\n        assert (\n            0.0 <= proportion <= 1.0\n        ), f\"'proportion' should be a float in range [0...1]. Got '{proportion}'.\"\n        self.new_col_name = f\"{self.pred_name}_neutralized_{self.proportion}\"\n        super().__init__(final_col_name=self.new_col_name)\n\n        self.feature_names = feature_names\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        feature_names = self.feature_names if self.feature_names else dataf.feature_cols\n        neutralized_preds = dataf.groupby(dataf.meta.era_col).apply(\n            lambda x: self.normalize_and_neutralize(x, [self.pred_name], feature_names)\n        )\n        dataf.loc[:, self.new_col_name] = MinMaxScaler().fit_transform(\n            neutralized_preds\n        )\n        rich_print(\n            f\":robot: Neutralized [bold blue]'{self.pred_name}'[bold blue] with proportion [bold]'{self.proportion}'[/bold] :robot:\"\n        )\n        rich_print(\n            f\"New neutralized column = [bold green]'{self.new_col_name}'[/bold green].\"\n        )\n        return NumerFrame(dataf)\n\n    def neutralize(self, dataf: pd.DataFrame, columns: list, by: list) -> pd.DataFrame:\n        scores = dataf[columns]\n        exposures = dataf[by].values\n        scores = scores - self.proportion * exposures.dot(\n            np.linalg.pinv(exposures).dot(scores)\n        )\n        return scores / scores.std()\n\n    @staticmethod\n    def normalize(dataf: pd.DataFrame) -> np.ndarray:\n        normalized_ranks = (dataf.rank(method=\"first\") - 0.5) / len(dataf)\n        return sp.norm.ppf(normalized_ranks)\n\n    def normalize_and_neutralize(\n        self, dataf: pd.DataFrame, columns: list, by: list\n    ) -> pd.DataFrame:\n        # Convert the scores to a normal distribution\n        dataf[columns] = self.normalize(dataf[columns])\n        dataf[columns] = self.neutralize(dataf, columns, by)\n        return dataf[columns]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_1_data.csv&quot;</span><span class="p">)</span>
<span class="n">test_dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="6f687826-c9ab-49dd-a397-2f330963cbf2"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6f687826-c9ab-49dd-a397-2f330963cbf2');

            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "test_dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\ntest_dataset.loc[:, 'prediction'] = np.random.uniform(size=len(test_dataset))";
                var nbb_formatted_code = "test_dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\ntest_dataset.loc[:, \"prediction\"] = np.random.uniform(size=len(test_dataset))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ft</span> <span class="o">=</span> <span class="n">FeatureNeutralizer</span><span class="p">(</span><span class="n">feature_names</span><span class="o">=</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">pred_name</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">new_dataset</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">🤖 Neutralized <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">'prediction'</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold"> with proportion </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">'0.8'</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold"> 🤖</span>
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">New neutralized column = <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">'prediction_neutralized_0.8'</span>.
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">FeatureNeutralizer</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">316</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">064430</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="d86af770-7116-4479-bd39-c15d9ca57e54"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d86af770-7116-4479-bd39-c15d9ca57e54');

            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "ft = FeatureNeutralizer(feature_names=test_dataset.feature_cols, pred_name='prediction', proportion=0.8)\nnew_dataset = ft.transform(test_dataset);";
                var nbb_formatted_code = "ft = FeatureNeutralizer(\n    feature_names=test_dataset.feature_cols, pred_name=\"prediction\", proportion=0.8\n)\nnew_dataset = ft.transform(test_dataset)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="s2">&quot;prediction_neutralized_0.8&quot;</span> <span class="ow">in</span> <span class="n">new_dataset</span><span class="o">.</span><span class="n">prediction_cols</span>
<span class="k">assert</span> <span class="mf">0.</span> <span class="ow">in</span> <span class="n">new_dataset</span><span class="o">.</span><span class="n">get_prediction_data</span><span class="p">[</span><span class="s1">&#39;prediction_neutralized_0.8&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="mf">1.</span> <span class="ow">in</span> <span class="n">new_dataset</span><span class="o">.</span><span class="n">get_prediction_data</span><span class="p">[</span><span class="s1">&#39;prediction_neutralized_0.8&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="28d0d082-f46f-4c1a-a020-70e9d4376c9c"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#28d0d082-f46f-4c1a-a020-70e9d4376c9c');

            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "assert \"prediction_neutralized_0.8\" in new_dataset.prediction_cols\nassert 0. in new_dataset.get_prediction_data['prediction_neutralized_0.8']\nassert 1. in new_dataset.get_prediction_data['prediction_neutralized_0.8']";
                var nbb_formatted_code = "assert \"prediction_neutralized_0.8\" in new_dataset.prediction_cols\nassert 0.0 in new_dataset.get_prediction_data[\"prediction_neutralized_0.8\"]\nassert 1.0 in new_dataset.get_prediction_data[\"prediction_neutralized_0.8\"]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_dataset</span><span class="o">.</span><span class="n">prediction_cols</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;prediction&#39;, &#39;prediction_neutralized_0.8&#39;]</pre>
</div>

</div>

<div class="output_area">




<div id="a5c316ec-5045-4eb4-ae22-1f233d00ca64"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#a5c316ec-5045-4eb4-ae22-1f233d00ca64');

            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "new_dataset.prediction_cols";
                var nbb_formatted_code = "new_dataset.prediction_cols";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_dataset</span><span class="o">.</span><span class="n">get_prediction_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction</th>
      <th>prediction_neutralized_0.8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.497874</td>
      <td>0.617129</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.876768</td>
      <td>0.815053</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.495809</td>
      <td>0.538198</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="967d945b-2b73-4049-818c-e2ea78e857ae"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#967d945b-2b73-4049-818c-e2ea78e857ae');

            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "new_dataset.get_prediction_data.head(3)";
                var nbb_formatted_code = "new_dataset.get_prediction_data.head(3)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.0.3.2.-Feature-Penalization">1.0.3.2. Feature Penalization<a class="anchor-link" href="#1.0.3.2.-Feature-Penalization"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FeaturePenalizer" class="doc_header"><code>class</code> <code>FeaturePenalizer</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L179" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FeaturePenalizer</code>(<strong><code>max_exposure</code></strong>:<code>float</code>, <strong><code>risky_feature_names</code></strong>:<code>list</code>=<em><code>None</code></em>, <strong><code>pred_name</code></strong>:<code>str</code>=<em><code>'prediction'</code></em>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<p>Feature penalization with Tensorflow.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="40164cde-ce1d-4a72-ac88-4d5d4c896f7e"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#40164cde-ce1d-4a72-ac88-4d5d4c896f7e');

            setTimeout(function() {
                var nbb_cell_id = 21;
                var nbb_unformatted_code = "#export\n@typechecked\nclass FeaturePenalizer(BasePostProcessor):\n    \"\"\" Feature penalization with Tensorflow. \"\"\"\n    def __init__(self, max_exposure: float,\n                 risky_feature_names: list = None, pred_name: str = \"prediction\"):\n        self.pred_name = pred_name\n        self.max_exposure = max_exposure\n        assert 0. <= max_exposure <= 1., f\"'max_exposure' should be a float in range [0...1]. Got '{max_exposure}'.\"\n        self.new_col_name = f\"{self.pred_name}_penalized_{self.max_exposure}\"\n        super().__init__(final_col_name=self.new_col_name)\n\n        self.risky_feature_names = risky_feature_names\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        risky_feature_names = dataf.feature_cols if not self.risky_feature_names else self.risky_feature_names\n        penalized_data = self.reduce_all_exposures(dataf=dataf,\n                                                   column=self.pred_name,\n                                                   neutralizers=risky_feature_names\n                                                   )\n        new_pred_col = f\"{self.pred_name}_FP_{self.max_exposure}\"\n        dataf.loc[:, new_pred_col] = penalized_data[self.pred_name]\n        return NumerFrame(dataf)\n\n    def reduce_all_exposures(self, dataf: NumerFrame,\n                             column: str = \"prediction\",\n                             neutralizers: list = None,\n                             normalize=True,\n                             gaussianize=True,\n                             ) -> pd.DataFrame:\n        if neutralizers is None:\n            neutralizers = [x for x in dataf.columns if x.startswith(\"feature\")]\n        neutralized = []\n\n        for era in tqdm(dataf[dataf.meta.era_col].unique()):\n            dataf_era = dataf[dataf[dataf.meta.era_col] == era]\n            scores = dataf_era[[column]].values\n            exposure_values = dataf_era[neutralizers].values\n\n            if normalize:\n                scores2 = []\n                for x in scores.T:\n                    x = (scipy.stats.rankdata(x, method='ordinal') - .5) / len(x)\n                    if gaussianize:\n                        x = scipy.stats.norm.ppf(x)\n                    scores2.append(x)\n                scores = np.array(scores2)[0]\n\n            scores, weights = self._reduce_exposure(scores, exposure_values,\n                                                    len(neutralizers), None)\n\n            scores /= tf.math.reduce_std(scores)\n            scores -= tf.reduce_min(scores)\n            scores /= tf.reduce_max(scores)\n            neutralized.append(scores.numpy())\n\n        predictions = pd.DataFrame(np.concatenate(neutralized),\n                                   columns=[column], index=df.index)\n        return predictions\n\n    def _reduce_exposure(self, prediction, features, input_size=50, weights=None):\n        model = tf.keras.models.Sequential([\n            tf.keras.layers.Input(input_size),\n            tf.keras.experimental.LinearModel(use_bias=False),\n        ])\n        feats = tf.convert_to_tensor(features - 0.5, dtype=tf.float32)\n        pred = tf.convert_to_tensor(prediction, dtype=tf.float32)\n        if weights is None:\n            optimizer = tf.keras.optimizers.Adamax()\n            start_exp = self.__exposures(feats, pred[:, None])\n            target_exps = tf.clip_by_value(start_exp, -self.max_exposure, self.max_exposure)\n            self._train_loop(model, optimizer, feats, pred, target_exps)\n        else:\n            model.set_weights(weights)\n        return pred[:,None] - model(feats), model.get_weights()\n\n\n    def _train_loop(self, model, optimizer, feats, pred, target_exps):\n        for i in range(1000000):\n            loss, grads = self.__train_loop_body(model, feats, pred, target_exps)\n            optimizer.apply_gradients(zip(grads, model.trainable_variables))\n            if loss < 1e-7:\n                break\n\n    @tf.function(experimental_relax_shapes=True)\n    def __train_loop_body(self, model, feats, pred, target_exps):\n        with tf.GradientTape() as tape:\n            exps = self.__exposures(feats, pred[:, None] - model(feats, training=True))\n            loss = tf.reduce_sum(tf.nn.relu(tf.nn.relu(exps) - tf.nn.relu(target_exps)) +\n                                 tf.nn.relu(tf.nn.relu(-exps) - tf.nn.relu(-target_exps)))\n        return loss, tape.gradient(loss, model.trainable_variables)\n\n    @staticmethod\n    @tf.function(experimental_relax_shapes=True, experimental_compile=True)\n    def __exposures(x, y):\n        x = x - tf.math.reduce_mean(x, axis=0)\n        x = x / tf.norm(x, axis=0)\n        y = y - tf.math.reduce_mean(y, axis=0)\n        y = y / tf.norm(y, axis=0)\n        return tf.matmul(x, y, transpose_a=True)";
                var nbb_formatted_code = "# export\n@typechecked\nclass FeaturePenalizer(BasePostProcessor):\n    \"\"\"Feature penalization with Tensorflow.\"\"\"\n\n    def __init__(\n        self,\n        max_exposure: float,\n        risky_feature_names: list = None,\n        pred_name: str = \"prediction\",\n    ):\n        self.pred_name = pred_name\n        self.max_exposure = max_exposure\n        assert (\n            0.0 <= max_exposure <= 1.0\n        ), f\"'max_exposure' should be a float in range [0...1]. Got '{max_exposure}'.\"\n        self.new_col_name = f\"{self.pred_name}_penalized_{self.max_exposure}\"\n        super().__init__(final_col_name=self.new_col_name)\n\n        self.risky_feature_names = risky_feature_names\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        risky_feature_names = (\n            dataf.feature_cols\n            if not self.risky_feature_names\n            else self.risky_feature_names\n        )\n        penalized_data = self.reduce_all_exposures(\n            dataf=dataf, column=self.pred_name, neutralizers=risky_feature_names\n        )\n        new_pred_col = f\"{self.pred_name}_FP_{self.max_exposure}\"\n        dataf.loc[:, new_pred_col] = penalized_data[self.pred_name]\n        return NumerFrame(dataf)\n\n    def reduce_all_exposures(\n        self,\n        dataf: NumerFrame,\n        column: str = \"prediction\",\n        neutralizers: list = None,\n        normalize=True,\n        gaussianize=True,\n    ) -> pd.DataFrame:\n        if neutralizers is None:\n            neutralizers = [x for x in dataf.columns if x.startswith(\"feature\")]\n        neutralized = []\n\n        for era in tqdm(dataf[dataf.meta.era_col].unique()):\n            dataf_era = dataf[dataf[dataf.meta.era_col] == era]\n            scores = dataf_era[[column]].values\n            exposure_values = dataf_era[neutralizers].values\n\n            if normalize:\n                scores2 = []\n                for x in scores.T:\n                    x = (scipy.stats.rankdata(x, method=\"ordinal\") - 0.5) / len(x)\n                    if gaussianize:\n                        x = scipy.stats.norm.ppf(x)\n                    scores2.append(x)\n                scores = np.array(scores2)[0]\n\n            scores, weights = self._reduce_exposure(\n                scores, exposure_values, len(neutralizers), None\n            )\n\n            scores /= tf.math.reduce_std(scores)\n            scores -= tf.reduce_min(scores)\n            scores /= tf.reduce_max(scores)\n            neutralized.append(scores.numpy())\n\n        predictions = pd.DataFrame(\n            np.concatenate(neutralized), columns=[column], index=df.index\n        )\n        return predictions\n\n    def _reduce_exposure(self, prediction, features, input_size=50, weights=None):\n        model = tf.keras.models.Sequential(\n            [\n                tf.keras.layers.Input(input_size),\n                tf.keras.experimental.LinearModel(use_bias=False),\n            ]\n        )\n        feats = tf.convert_to_tensor(features - 0.5, dtype=tf.float32)\n        pred = tf.convert_to_tensor(prediction, dtype=tf.float32)\n        if weights is None:\n            optimizer = tf.keras.optimizers.Adamax()\n            start_exp = self.__exposures(feats, pred[:, None])\n            target_exps = tf.clip_by_value(\n                start_exp, -self.max_exposure, self.max_exposure\n            )\n            self._train_loop(model, optimizer, feats, pred, target_exps)\n        else:\n            model.set_weights(weights)\n        return pred[:, None] - model(feats), model.get_weights()\n\n    def _train_loop(self, model, optimizer, feats, pred, target_exps):\n        for i in range(1000000):\n            loss, grads = self.__train_loop_body(model, feats, pred, target_exps)\n            optimizer.apply_gradients(zip(grads, model.trainable_variables))\n            if loss < 1e-7:\n                break\n\n    @tf.function(experimental_relax_shapes=True)\n    def __train_loop_body(self, model, feats, pred, target_exps):\n        with tf.GradientTape() as tape:\n            exps = self.__exposures(feats, pred[:, None] - model(feats, training=True))\n            loss = tf.reduce_sum(\n                tf.nn.relu(tf.nn.relu(exps) - tf.nn.relu(target_exps))\n                + tf.nn.relu(tf.nn.relu(-exps) - tf.nn.relu(-target_exps))\n            )\n        return loss, tape.gradient(loss, model.trainable_variables)\n\n    @staticmethod\n    @tf.function(experimental_relax_shapes=True, experimental_compile=True)\n    def __exposures(x, y):\n        x = x - tf.math.reduce_mean(x, axis=0)\n        x = x / tf.norm(x, axis=0)\n        y = y - tf.math.reduce_mean(y, axis=0)\n        y = y / tf.norm(y, axis=0)\n        return tf.matmul(x, y, transpose_a=True)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_1_data.csv&quot;</span><span class="p">)</span>
<span class="n">test_dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="4e2b024b-6a14-41ca-9cca-ea7301cb2e39"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#4e2b024b-6a14-41ca-9cca-ea7301cb2e39');

            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "# TODO Test Feature penalizer\ntest_dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\ntest_dataset.loc[:, 'prediction'] = np.random.uniform(size=len(test_dataset))";
                var nbb_formatted_code = "# TODO Test Feature penalizer\ntest_dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\ntest_dataset.loc[:, \"prediction\"] = np.random.uniform(size=len(test_dataset))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ft</span> <span class="o">=</span> <span class="n">FeaturePenalizer</span><span class="p">(</span><span class="n">pred_name</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">max_exposure</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">new_dataset</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-02-11 11:30:48.792539: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-02-11 11:30:49.031988: I tensorflow/compiler/xla/service/service.cc:171] XLA service 0x7fbb0f38a6e0 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2022-02-11 11:30:49.032021: I tensorflow/compiler/xla/service/service.cc:179]   StreamExecutor device (0): Host, Default Version
2022-02-11 11:30:49.043229: I tensorflow/compiler/mlir/tensorflow/utils/dump_mlir_util.cc:237] disabling MLIR crash reproducer, set env var `MLIR_CRASH_REPRODUCER_DIRECTORY` to enable.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>WARNING:tensorflow:AutoGraph could not transform &lt;bound method FeaturePenalizer.__train_loop_body of &lt;tensorflow.python.eager.function.TfMethodTarget object at 0x7fbb10a81850&gt;&gt; and will run it as-is.
Cause: mangled names are not yet supported
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
WARNING: AutoGraph could not transform &lt;bound method FeaturePenalizer.__train_loop_body of &lt;tensorflow.python.eager.function.TfMethodTarget object at 0x7fbb10a81850&gt;&gt; and will run it as-is.
Cause: mangled names are not yet supported
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-02-11 11:30:49.635413: I tensorflow/compiler/jit/xla_compilation_cache.cc:351] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_1191/2807515342.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> ft <span class="ansi-blue-fg">=</span> FeaturePenalizer<span class="ansi-blue-fg">(</span>pred_name<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;prediction&#39;</span><span class="ansi-blue-fg">,</span> max_exposure<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.8</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>new_dataset <span class="ansi-blue-fg">=</span> ft<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">(</span>test_dataset<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/typeguard/__init__.py</span> in <span class="ansi-cyan-fg">wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1031</span>         memo <span class="ansi-blue-fg">=</span> _CallMemo<span class="ansi-blue-fg">(</span>python_func<span class="ansi-blue-fg">,</span> _localns<span class="ansi-blue-fg">,</span> args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span> kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1032</span>         check_argument_types<span class="ansi-blue-fg">(</span>memo<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1033</span><span class="ansi-red-fg">         </span>retval <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1034</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1035</span>             check_return_type<span class="ansi-blue-fg">(</span>retval<span class="ansi-blue-fg">,</span> memo<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Desktop/crowdcent/repositories/numerai-blocks/numerai_blocks/preprocessing.py</span> in <span class="ansi-cyan-fg">wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     36</span>     <span class="ansi-green-fg">def</span> wrapper<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     37</span>         tic <span class="ansi-blue-fg">=</span> dt<span class="ansi-blue-fg">.</span>datetime<span class="ansi-blue-fg">.</span>now<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 38</span><span class="ansi-red-fg">         </span>result <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     39</span>         time_taken <span class="ansi-blue-fg">=</span> str<span class="ansi-blue-fg">(</span>dt<span class="ansi-blue-fg">.</span>datetime<span class="ansi-blue-fg">.</span>now<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-</span> tic<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     40</span>         class_name <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">.</span>__qualname__<span class="ansi-blue-fg">.</span>split<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;.&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_1191/814338343.py</span> in <span class="ansi-cyan-fg">transform</span><span class="ansi-blue-fg">(self, dataf)</span>
<span class="ansi-green-intense-fg ansi-bold">     18</span>         penalized_data = self.reduce_all_exposures(dataf=dataf,
<span class="ansi-green-intense-fg ansi-bold">     19</span>                                                    column<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>pred_name<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 20</span><span class="ansi-red-fg">                                                    </span>neutralizers<span class="ansi-blue-fg">=</span>risky_feature_names
<span class="ansi-green-intense-fg ansi-bold">     21</span>                                                    )
<span class="ansi-green-intense-fg ansi-bold">     22</span>         new_pred_col <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">f&#34;{self.pred_name}_FP_{self.max_exposure}&#34;</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/typeguard/__init__.py</span> in <span class="ansi-cyan-fg">wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1031</span>         memo <span class="ansi-blue-fg">=</span> _CallMemo<span class="ansi-blue-fg">(</span>python_func<span class="ansi-blue-fg">,</span> _localns<span class="ansi-blue-fg">,</span> args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span> kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1032</span>         check_argument_types<span class="ansi-blue-fg">(</span>memo<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1033</span><span class="ansi-red-fg">         </span>retval <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1034</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1035</span>             check_return_type<span class="ansi-blue-fg">(</span>retval<span class="ansi-blue-fg">,</span> memo<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_1191/814338343.py</span> in <span class="ansi-cyan-fg">reduce_all_exposures</span><span class="ansi-blue-fg">(self, dataf, column, neutralizers, normalize, gaussianize)</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span> 
<span class="ansi-green-intense-fg ansi-bold">     50</span>             scores, weights = self._reduce_exposure(scores, exposure_values,
<span class="ansi-green-fg">---&gt; 51</span><span class="ansi-red-fg">                                                     len(neutralizers), None)
</span><span class="ansi-green-intense-fg ansi-bold">     52</span> 
<span class="ansi-green-intense-fg ansi-bold">     53</span>             scores <span class="ansi-blue-fg">/=</span> tf<span class="ansi-blue-fg">.</span>math<span class="ansi-blue-fg">.</span>reduce_std<span class="ansi-blue-fg">(</span>scores<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_1191/814338343.py</span> in <span class="ansi-cyan-fg">_reduce_exposure</span><span class="ansi-blue-fg">(self, prediction, features, input_size, weights)</span>
<span class="ansi-green-intense-fg ansi-bold">     71</span>             start_exp <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>__exposures<span class="ansi-blue-fg">(</span>feats<span class="ansi-blue-fg">,</span> pred<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span>             target_exps <span class="ansi-blue-fg">=</span> tf<span class="ansi-blue-fg">.</span>clip_by_value<span class="ansi-blue-fg">(</span>start_exp<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">-</span>self<span class="ansi-blue-fg">.</span>max_exposure<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>max_exposure<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 73</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_train_loop<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">,</span> optimizer<span class="ansi-blue-fg">,</span> feats<span class="ansi-blue-fg">,</span> pred<span class="ansi-blue-fg">,</span> target_exps<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     74</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     75</span>             model<span class="ansi-blue-fg">.</span>set_weights<span class="ansi-blue-fg">(</span>weights<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_1191/814338343.py</span> in <span class="ansi-cyan-fg">_train_loop</span><span class="ansi-blue-fg">(self, model, optimizer, feats, pred, target_exps)</span>
<span class="ansi-green-intense-fg ansi-bold">     79</span>     <span class="ansi-green-fg">def</span> _train_loop<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> model<span class="ansi-blue-fg">,</span> optimizer<span class="ansi-blue-fg">,</span> feats<span class="ansi-blue-fg">,</span> pred<span class="ansi-blue-fg">,</span> target_exps<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     80</span>         <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1000000</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 81</span><span class="ansi-red-fg">             </span>loss<span class="ansi-blue-fg">,</span> grads <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>__train_loop_body<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">,</span> feats<span class="ansi-blue-fg">,</span> pred<span class="ansi-blue-fg">,</span> target_exps<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     82</span>             optimizer<span class="ansi-blue-fg">.</span>apply_gradients<span class="ansi-blue-fg">(</span>zip<span class="ansi-blue-fg">(</span>grads<span class="ansi-blue-fg">,</span> model<span class="ansi-blue-fg">.</span>trainable_variables<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     83</span>             <span class="ansi-green-fg">if</span> loss <span class="ansi-blue-fg">&lt;</span> <span class="ansi-cyan-fg">1e-7</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/util/traceback_utils.py</span> in <span class="ansi-cyan-fg">error_handler</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    148</span>     filtered_tb <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-intense-fg ansi-bold">    149</span>     <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 150</span><span class="ansi-red-fg">       </span><span class="ansi-green-fg">return</span> fn<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    151</span>     <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    152</span>       filtered_tb <span class="ansi-blue-fg">=</span> _process_traceback_frames<span class="ansi-blue-fg">(</span>e<span class="ansi-blue-fg">.</span>__traceback__<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwds)</span>
<span class="ansi-green-intense-fg ansi-bold">    908</span> 
<span class="ansi-green-intense-fg ansi-bold">    909</span>       <span class="ansi-green-fg">with</span> OptionalXlaContext<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_jit_compile<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 910</span><span class="ansi-red-fg">         </span>result <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_call<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwds<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    911</span> 
<span class="ansi-green-intense-fg ansi-bold">    912</span>       new_tracing_count <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>experimental_get_tracing_count<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py</span> in <span class="ansi-cyan-fg">_call</span><span class="ansi-blue-fg">(self, *args, **kwds)</span>
<span class="ansi-green-intense-fg ansi-bold">    947</span>       <span class="ansi-red-fg"># In this case we have not created variables on the first call. So we can</span>
<span class="ansi-green-intense-fg ansi-bold">    948</span>       <span class="ansi-red-fg"># run the first trace but we should fail if variables are created.</span>
<span class="ansi-green-fg">--&gt; 949</span><span class="ansi-red-fg">       </span>results <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_stateful_fn<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwds<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    950</span>       <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_created_variables <span class="ansi-green-fg">and</span> <span class="ansi-green-fg">not</span> ALLOW_DYNAMIC_VARIABLE_CREATION<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    951</span>         raise ValueError(&#34;Creating variables on a non-first call to a function&#34;

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   3129</span>        filtered_flat_args) = self._maybe_define_function(args, kwargs)
<span class="ansi-green-intense-fg ansi-bold">   3130</span>     return graph_function._call_flat(
<span class="ansi-green-fg">-&gt; 3131</span><span class="ansi-red-fg">         filtered_flat_args, captured_inputs=graph_function.captured_inputs)  # pylint: disable=protected-access
</span><span class="ansi-green-intense-fg ansi-bold">   3132</span> 
<span class="ansi-green-intense-fg ansi-bold">   3133</span>   <span class="ansi-blue-fg">@</span>property

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ansi-cyan-fg">_call_flat</span><span class="ansi-blue-fg">(self, args, captured_inputs, cancellation_manager)</span>
<span class="ansi-green-intense-fg ansi-bold">   1958</span>       <span class="ansi-red-fg"># No tape is watching; skip to running the function.</span>
<span class="ansi-green-intense-fg ansi-bold">   1959</span>       return self._build_call_outputs(self._inference_function.call(
<span class="ansi-green-fg">-&gt; 1960</span><span class="ansi-red-fg">           ctx, args, cancellation_manager=cancellation_manager))
</span><span class="ansi-green-intense-fg ansi-bold">   1961</span>     forward_backward = self._select_forward_and_backward_functions(
<span class="ansi-green-intense-fg ansi-bold">   1962</span>         args<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ansi-cyan-fg">call</span><span class="ansi-blue-fg">(self, ctx, args, cancellation_manager)</span>
<span class="ansi-green-intense-fg ansi-bold">    591</span>     executor_type <span class="ansi-blue-fg">=</span> function_call_options<span class="ansi-blue-fg">.</span>executor_type <span class="ansi-green-fg">or</span> <span class="ansi-blue-fg">&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    592</span> 
<span class="ansi-green-fg">--&gt; 593</span><span class="ansi-red-fg">     </span>executing_eagerly <span class="ansi-blue-fg">=</span> ctx<span class="ansi-blue-fg">.</span>executing_eagerly<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    594</span>     attrs <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;executor_type&#34;</span><span class="ansi-blue-fg">,</span> executor_type<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;config_proto&#34;</span><span class="ansi-blue-fg">,</span> config<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    595</span>     <span class="ansi-green-fg">if</span> executing_eagerly<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/tensorflow/python/eager/context.py</span> in <span class="ansi-cyan-fg">executing_eagerly</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    903</span>   <span class="ansi-green-fg">def</span> executing_eagerly<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    904</span>     <span class="ansi-blue-fg">&#34;&#34;&#34;Returns True if current thread has eager executing enabled.&#34;&#34;&#34;</span>
<span class="ansi-green-fg">--&gt; 905</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_thread_local_data<span class="ansi-blue-fg">.</span>is_eager
<span class="ansi-green-intense-fg ansi-bold">    906</span> 
<span class="ansi-green-intense-fg ansi-bold">    907</span>   <span class="ansi-green-fg">def</span> ones_rank_cache<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

<div class="output_area">




<div id="6f8d86a2-2e6f-479c-8115-6d98291eef97"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6f8d86a2-2e6f-479c-8115-6d98291eef97');

            setTimeout(function() {
                var nbb_cell_id = 23;
                var nbb_unformatted_code = "ft = FeaturePenalizer(pred_name='prediction', max_exposure=0.8)\nnew_dataset = ft.transform(test_dataset);";
                var nbb_formatted_code = "ft = FeaturePenalizer(pred_name=\"prediction\", max_exposure=0.8)\nnew_dataset = ft.transform(test_dataset)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.2.-Numerai-Classic">1.2. Numerai Classic<a class="anchor-link" href="#1.2.-Numerai-Classic"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Postprocessing steps that are specific to Numerai Classic</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.3.-Signals">1.3. Signals<a class="anchor-link" href="#1.3.-Signals"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Postprocessors that are specific to Numerai Signals.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Custom-PostProcessors">2. Custom PostProcessors<a class="anchor-link" href="#2.-Custom-PostProcessors"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As with preprocessors, there are an almost unlimited number of ways to postprocess data. We (once again) invite the Numerai community to develop Numerai Classic and Signals postprocessors for <code>numerai-blocks</code>.</p>
<p>A new Postprocessor should inherit from <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a> and implement a <code>transform</code> method. The <code>transform</code> method should take a <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> as input and return a <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> object as output. A template for this is given below.</p>
<p>We recommend adding <code>@typechecked</code> at the top of a new PostProcessor class to enforce types and provide useful debugging stacktraces. To enable fancy logging output. Add the <code>@display_processor_info</code> decorator to the <code>transform</code> method.</p>
<p>Note that arbitrary metadata can be added or changed in the <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> class during a postprocessing step.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AwesomePostProcessor" class="doc_header"><code>class</code> <code>AwesomePostProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/postprocessing.py#L281" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AwesomePostProcessor</code>(<strong><code>final_col_name</code></strong>:<code>str</code>, <strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/numerai_blocks/postprocessing.html#BasePostProcessor"><code>BasePostProcessor</code></a></p>
</blockquote>
<ul>
<li>TEMPLATE -
Do some awesome postprocessing.
:param final_col_name: Column name to store manipulated or ensembled predictions in.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
</div>
 

