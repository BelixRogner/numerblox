---

title: Preprocessing


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/03_preprocessing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_preprocessing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">load_ext</span> nb_black
<span class="o">%</span><span class="k">load_ext</span> lab_black
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="b7c7218c-cc3b-425b-b3cf-3bab9046f346"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#b7c7218c-cc3b-425b-b3cf-3bab9046f346');

            setTimeout(function() {
                var nbb_cell_id = 1;
                var nbb_unformatted_code = "%load_ext autoreload\n%autoreload 2\n%load_ext nb_black\n%load_ext lab_black";
                var nbb_formatted_code = "%load_ext autoreload\n%autoreload 2\n%load_ext nb_black\n%load_ext lab_black";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="0.-Base">0. Base<a class="anchor-link" href="#0.-Base"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This objects will provide a solid base for all processing (pre and post) and log relevant information regarding the data pipeline.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="0.1.-BaseProcessor">0.1. BaseProcessor<a class="anchor-link" href="#0.1.-BaseProcessor"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a> defines common functionality for Preprocessors and Postprocessors (Section 5).</p>
<p>Every Preprocessor should inherit from <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a> and implement the <code>.transform</code> method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseProcessor" class="doc_header"><code>class</code> <code>BaseProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L20" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseProcessor</code>() :: <code>ABC</code></p>
</blockquote>
<p>Common functionality for preprocessors and postprocessors.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="bc434b72-c445-4f0b-84b9-f0d52e6691fb"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#bc434b72-c445-4f0b-84b9-f0d52e6691fb');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "#export\nclass BaseProcessor(ABC):\n    \"\"\" Common functionality for preprocessors and postprocessors. \"\"\"\n    def __init__(self):\n        ...\n\n    @abstractmethod\n    def transform(self, dataf: Union[pd.DataFrame, NumerFrame], *args, **kwargs) -> NumerFrame:\n        ...\n\n    def __call__(self, dataf: Union[pd.DataFrame, NumerFrame], *args, **kwargs) -> NumerFrame:\n        return self.transform(dataf=dataf, *args, **kwargs)";
                var nbb_formatted_code = "# export\nclass BaseProcessor(ABC):\n    \"\"\"Common functionality for preprocessors and postprocessors.\"\"\"\n\n    def __init__(self):\n        ...\n\n    @abstractmethod\n    def transform(\n        self, dataf: Union[pd.DataFrame, NumerFrame], *args, **kwargs\n    ) -> NumerFrame:\n        ...\n\n    def __call__(\n        self, dataf: Union[pd.DataFrame, NumerFrame], *args, **kwargs\n    ) -> NumerFrame:\n        return self.transform(dataf=dataf, *args, **kwargs)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="0.3.-Logging">0.3. Logging<a class="anchor-link" href="#0.3.-Logging"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We would like to keep an overview of which steps are done in a data pipeline and where processing bottlenecks occur.
The decorator below will display:</p>
<ol>
<li>When a step has finished.</li>
<li>What the output shape of the data is.</li>
<li>How long the step took to finish.</li>
</ol>
<p>To use this functionality, simply add <code>@display_processor_info</code> as a decorator to the function/method you want to track.</p>
<p>We will use this decorator throughout the pipeline (preprocessing, model and postprocessing).</p>
<p>Inspiration for this decorator: <a href="https://calmcode.io/pandas-pipe/logs.html">Calmcode Pandas Pipe Logs</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="display_processor_info" class="doc_header"><code>display_processor_info</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L33" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>display_processor_info</code>(<strong><code>func</code></strong>)</p>
</blockquote>
<p>Fancy console output for data processing.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="807c6331-64be-4123-90b5-a2f3148cf751"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#807c6331-64be-4123-90b5-a2f3148cf751');

            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "#export\ndef display_processor_info(func):\n    \"\"\" Fancy console output for data processing. \"\"\"\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        tic = dt.datetime.now()\n        result = func(*args, **kwargs)\n        time_taken = str(dt.datetime.now() - tic)\n        class_name = func.__qualname__.split('.')[0]\n        rich_print(f\":white_check_mark: Finished step [bold]{class_name}[/bold]. Output shape={result.shape}. Time taken for step: [blue]{time_taken}[/blue]. :white_check_mark:\")\n        return result\n    return wrapper";
                var nbb_formatted_code = "# export\ndef display_processor_info(func):\n    \"\"\"Fancy console output for data processing.\"\"\"\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        tic = dt.datetime.now()\n        result = func(*args, **kwargs)\n        time_taken = str(dt.datetime.now() - tic)\n        class_name = func.__qualname__.split(\".\")[0]\n        rich_print(\n            f\":white_check_mark: Finished step [bold]{class_name}[/bold]. Output shape={result.shape}. Time taken for step: [blue]{time_taken}[/blue]. :white_check_mark:\"\n        )\n        return result\n\n    return wrapper";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestDisplay</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Small test for logging.</span>
<span class="sd">    Output should mention &#39;TestDisplay&#39;,</span>
<span class="sd">    Return output shape of (10, 314) and</span>
<span class="sd">    time taken for step should be close to 2 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataf</span><span class="p">:</span> <span class="n">NumerFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataf</span> <span class="o">=</span> <span class="n">dataf</span>
    <span class="nd">@display_processor_info</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumerFrame</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataf</span>

<span class="n">dataf</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_1_data.csv&quot;</span><span class="p">)</span>
<span class="n">TestDisplay</span><span class="p">(</span><span class="n">dataf</span><span class="p">)</span><span class="o">.</span><span class="n">test</span><span class="p">();</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">TestDisplay</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">314</span><span style="font-weight: bold">)</span>. Time taken for step: <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:02</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">004741</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="562d4543-2124-4fbf-98c0-4fe2e8e7c1ea"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#562d4543-2124-4fbf-98c0-4fe2e8e7c1ea');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "class TestDisplay:\n    \"\"\"\n    Small test for logging.\n    Output should mention 'TestDisplay',\n    Return output shape of (10, 314) and\n    time taken for step should be close to 2 seconds.\n    \"\"\"\n    def __init__(self, dataf: NumerFrame):\n        self.dataf = dataf\n    @display_processor_info\n    def test(self) -> NumerFrame:\n        time.sleep(2)\n        return self.dataf\n\ndataf = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\nTestDisplay(dataf).test();";
                var nbb_formatted_code = "class TestDisplay:\n    \"\"\"\n    Small test for logging.\n    Output should mention 'TestDisplay',\n    Return output shape of (10, 314) and\n    time taken for step should be close to 2 seconds.\n    \"\"\"\n\n    def __init__(self, dataf: NumerFrame):\n        self.dataf = dataf\n\n    @display_processor_info\n    def test(self) -> NumerFrame:\n        time.sleep(2)\n        return self.dataf\n\n\ndataf = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\")\nTestDisplay(dataf).test()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Common-preprocessing-steps">1. Common preprocessing steps<a class="anchor-link" href="#1.-Common-preprocessing-steps"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We invite the Numerai community to develop new preprocessors. This section implements commonly used preprocessing for Numerai.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.0-Tournament-agnostic">1.0 Tournament agnostic<a class="anchor-link" href="#1.0-Tournament-agnostic"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This section cover all the available Preprocessors that can be applied for both Numerai Classic and Numerai Signals.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.0.1.-CopyPreProcessor">1.0.1. CopyPreProcessor<a class="anchor-link" href="#1.0.1.-CopyPreProcessor"> </a></h4><p>The first and obvious preprocessor is copying, which is implemented as a default in <a href="/numerai_blocks/modelpipeline.html#ModelPipeline"><code>ModelPipeline</code></a> (Section 4) to avoid manipulation of the original Dataset that you load in.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CopyPreProcessor" class="doc_header"><code>class</code> <code>CopyPreProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L47" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CopyPreProcessor</code>() :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<p>Copy DataFrame to avoid manipulation of original DataFrame.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e3eae07c-ba22-4e53-b8ff-4a85c8172491"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e3eae07c-ba22-4e53-b8ff-4a85c8172491');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "#export\n@typechecked\nclass CopyPreProcessor(BaseProcessor):\n    \"\"\"Copy DataFrame to avoid manipulation of original DataFrame. \"\"\"\n    def __init__(self):\n        super().__init__()\n\n    @display_processor_info\n    def transform(self, dataf: Union[pd.DataFrame, NumerFrame]) -> Union[pd.DataFrame, NumerFrame]:\n        return dataf.copy()";
                var nbb_formatted_code = "# export\n@typechecked\nclass CopyPreProcessor(BaseProcessor):\n    \"\"\"Copy DataFrame to avoid manipulation of original DataFrame.\"\"\"\n\n    def __init__(self):\n        super().__init__()\n\n    @display_processor_info\n    def transform(\n        self, dataf: Union[pd.DataFrame, NumerFrame]\n    ) -> Union[pd.DataFrame, NumerFrame]:\n        return dataf.copy()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_1_data.csv&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">copied_dataset</span> <span class="o">=</span> <span class="n">CopyPreProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">copied_dataset</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">meta</span> <span class="o">==</span> <span class="n">copied_dataset</span><span class="o">.</span><span class="n">meta</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">CopyPreProcessor</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">314</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">001015</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="a2b0bfec-9b7b-4f03-af48-f45be4c90dd8"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#a2b0bfec-9b7b-4f03-af48-f45be4c90dd8');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\", metadata={\"version\": 1})\ncopied_dataset = CopyPreProcessor().transform(dataset)\nassert np.array_equal(copied_dataset.values, dataset.values)\nassert dataset.meta == copied_dataset.meta";
                var nbb_formatted_code = "dataset = create_numerframe(\n    \"test_assets/mini_numerai_version_1_data.csv\", metadata={\"version\": 1}\n)\ncopied_dataset = CopyPreProcessor().transform(dataset)\nassert np.array_equal(copied_dataset.values, dataset.values)\nassert dataset.meta == copied_dataset.meta";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.0.2.-FeatureSelectionPreProcessor">1.0.2. FeatureSelectionPreProcessor<a class="anchor-link" href="#1.0.2.-FeatureSelectionPreProcessor"> </a></h4><p><a href="/numerai_blocks/preprocessing.html#FeatureSelectionPreProcessor"><code>FeatureSelectionPreProcessor</code></a> will keep all features that you pass + keeps all other columns that are not features.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FeatureSelectionPreProcessor" class="doc_header"><code>class</code> <code>FeatureSelectionPreProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L58" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FeatureSelectionPreProcessor</code>(<strong><code>feature_cols</code></strong>:<code>Union</code>[<code>str</code>, <code>list</code>]) :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<p>Keep only features given + all target, predictions and aux columns.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="8254b290-db96-49f0-979b-a9fad9b94d43"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#8254b290-db96-49f0-979b-a9fad9b94d43');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "#export\n@typechecked\nclass FeatureSelectionPreProcessor(BaseProcessor):\n    \"\"\"\n    Keep only features given + all target, predictions and aux columns.\n    \"\"\"\n    def __init__(self, feature_cols: Union[str, list]):\n        super().__init__()\n        self.feature_cols = feature_cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        keep_cols = self.feature_cols + dataf.target_cols + dataf.prediction_cols + dataf.aux_cols\n        dataf = dataf.loc[:, keep_cols]\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\n@typechecked\nclass FeatureSelectionPreProcessor(BaseProcessor):\n    \"\"\"\n    Keep only features given + all target, predictions and aux columns.\n    \"\"\"\n\n    def __init__(self, feature_cols: Union[str, list]):\n        super().__init__()\n        self.feature_cols = feature_cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        keep_cols = (\n            self.feature_cols\n            + dataf.target_cols\n            + dataf.prediction_cols\n            + dataf.aux_cols\n        )\n        dataf = dataf.loc[:, keep_cols]\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">selected_dataset</span> <span class="o">=</span> <span class="n">FeatureSelectionPreProcessor</span><span class="p">(</span><span class="n">feature_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature_wisdom1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">selected_dataset</span><span class="o">.</span><span class="n">get_feature_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">meta</span> <span class="o">==</span> <span class="n">selected_dataset</span><span class="o">.</span><span class="n">meta</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">FeatureSelectionPreProcessor</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">001408</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="c739dcc1-521b-478f-baa1-702e11934ddd"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c739dcc1-521b-478f-baa1-702e11934ddd');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "selected_dataset = FeatureSelectionPreProcessor(feature_cols=['feature_wisdom1']).transform(dataset)\nassert selected_dataset.get_feature_data.shape[1] == 1\nassert dataset.meta == selected_dataset.meta";
                var nbb_formatted_code = "selected_dataset = FeatureSelectionPreProcessor(\n    feature_cols=[\"feature_wisdom1\"]\n).transform(dataset)\nassert selected_dataset.get_feature_data.shape[1] == 1\nassert dataset.meta == selected_dataset.meta";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">selected_dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature_wisdom1</th>
      <th>target</th>
      <th>id</th>
      <th>era</th>
      <th>data_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.25</td>
      <td>0.50</td>
      <td>n000315175b67977</td>
      <td>era1</td>
      <td>train</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.50</td>
      <td>0.25</td>
      <td>n0014af834a96cdd</td>
      <td>era1</td>
      <td>train</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="0f2ebc66-0029-46b0-9ef3-fbb2220a6394"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#0f2ebc66-0029-46b0-9ef3-fbb2220a6394');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "selected_dataset.head(2)";
                var nbb_formatted_code = "selected_dataset.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.0.2.-TargetSelectionPreProcessor">1.0.2. TargetSelectionPreProcessor<a class="anchor-link" href="#1.0.2.-TargetSelectionPreProcessor"> </a></h4><p><a href="/numerai_blocks/preprocessing.html#TargetSelectionPreProcessor"><code>TargetSelectionPreProcessor</code></a> will keep all targets that you pass + all other columns that are not targets.</p>
<p>Not relevant for an inference pipeline, but especially convenient for Numerai Classic training if you train on a subset of the available targets. Can also be applied to Signals if you are using multiple engineered targets in your pipeline.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TargetSelectionPreProcessor" class="doc_header"><code>class</code> <code>TargetSelectionPreProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L74" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TargetSelectionPreProcessor</code>(<strong><code>target_cols</code></strong>:<code>Union</code>[<code>str</code>, <code>list</code>]) :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<p>Keep only features given + all target, predictions and aux columns.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="2de16d7f-ef38-4dad-a412-fdac6e218610"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#2de16d7f-ef38-4dad-a412-fdac6e218610');

            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "#export\n@typechecked\nclass TargetSelectionPreProcessor(BaseProcessor):\n    \"\"\"\n    Keep only features given + all target, predictions and aux columns.\n    \"\"\"\n    def __init__(self, target_cols: Union[str, list]):\n        super().__init__()\n        self.target_cols = target_cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        keep_cols = self.target_cols + dataf.feature_cols + dataf.prediction_cols + dataf.aux_cols\n        dataf = dataf.loc[:, keep_cols]\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\n@typechecked\nclass TargetSelectionPreProcessor(BaseProcessor):\n    \"\"\"\n    Keep only features given + all target, predictions and aux columns.\n    \"\"\"\n\n    def __init__(self, target_cols: Union[str, list]):\n        super().__init__()\n        self.target_cols = target_cols\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame) -> NumerFrame:\n        keep_cols = (\n            self.target_cols\n            + dataf.feature_cols\n            + dataf.prediction_cols\n            + dataf.aux_cols\n        )\n        dataf = dataf.loc[:, keep_cols]\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_2_data.parquet&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;target_nomi_20&#39;</span><span class="p">,</span> <span class="s1">&#39;target_nomi_60&#39;</span><span class="p">]</span>
<span class="n">selected_dataset</span> <span class="o">=</span> <span class="n">TargetSelectionPreProcessor</span><span class="p">(</span><span class="n">target_cols</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">selected_dataset</span><span class="o">.</span><span class="n">get_target_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_cols</span><span class="p">)</span>
<span class="n">selected_dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">TargetSelectionPreProcessor</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1055</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">016798</span>. ✅
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>target</th>
      <th>target_nomi_20</th>
      <th>target_nomi_60</th>
      <th>feature_dichasial_hammier_spawner</th>
      <th>feature_rheumy_epistemic_prancer</th>
      <th>feature_pert_performative_hormuz</th>
      <th>feature_hillier_unpitied_theobromine</th>
      <th>feature_perigean_bewitching_thruster</th>
      <th>feature_renegade_undomestic_milord</th>
      <th>feature_koranic_rude_corf</th>
      <th>...</th>
      <th>feature_drawable_exhortative_dispersant</th>
      <th>feature_metabolic_minded_armorist</th>
      <th>feature_investigatory_inerasable_circumvallation</th>
      <th>feature_centroclinal_incentive_lancelet</th>
      <th>feature_unemotional_quietistic_chirper</th>
      <th>feature_behaviorist_microbiological_farina</th>
      <th>feature_lofty_acceptable_challenge</th>
      <th>feature_coactive_prefatorial_lucy</th>
      <th>era</th>
      <th>data_type</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n559bd06a8861222</th>
      <td>0.25</td>
      <td>0.25</td>
      <td>0.50</td>
      <td>0.25</td>
      <td>0.75</td>
      <td>0.25</td>
      <td>0.75</td>
      <td>0.25</td>
      <td>0.50</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>1.00</td>
      <td>0.25</td>
      <td>0297</td>
      <td>train</td>
    </tr>
    <tr>
      <th>n9d39dea58c9e3cf</th>
      <td>0.50</td>
      <td>0.50</td>
      <td>0.75</td>
      <td>0.75</td>
      <td>0.50</td>
      <td>0.75</td>
      <td>1.00</td>
      <td>0.50</td>
      <td>0.25</td>
      <td>0.5</td>
      <td>...</td>
      <td>0.25</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>0.75</td>
      <td>1.0</td>
      <td>0.75</td>
      <td>1.00</td>
      <td>0003</td>
      <td>train</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 1055 columns</p>
</div>
</div>

</div>

<div class="output_area">




<div id="f9962be3-5fee-4bdc-9df4-f6bc87a15af7"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f9962be3-5fee-4bdc-9df4-f6bc87a15af7');

            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "dataset = create_numerframe(\"test_assets/mini_numerai_version_2_data.parquet\", metadata={\"version\": 2})\ntarget_cols = ['target', 'target_nomi_20', 'target_nomi_60']\nselected_dataset = TargetSelectionPreProcessor(target_cols=target_cols).transform(dataset)\nassert selected_dataset.get_target_data.shape[1] == len(target_cols)\nselected_dataset.head(2)";
                var nbb_formatted_code = "dataset = create_numerframe(\n    \"test_assets/mini_numerai_version_2_data.parquet\", metadata={\"version\": 2}\n)\ntarget_cols = [\"target\", \"target_nomi_20\", \"target_nomi_60\"]\nselected_dataset = TargetSelectionPreProcessor(target_cols=target_cols).transform(\n    dataset\n)\nassert selected_dataset.get_target_data.shape[1] == len(target_cols)\nselected_dataset.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.1.-Numerai-Classic">1.1. Numerai Classic<a class="anchor-link" href="#1.1.-Numerai-Classic"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Numerai Classic dataset has a certain structure that you may not encounter in the Numerai Signals tournament.
Therefore, this section has all preprocessors that can only be applied to Numerai Classic.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.1.0-Numerai-Classic:-Version-agnostic">1.1.0 Numerai Classic: Version agnostic<a class="anchor-link" href="#1.1.0-Numerai-Classic:-Version-agnostic"> </a></h4><p>Preprocessors that work for all Numerai Classic versions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.1.1.-Numerai-Classic:-Version-1-specific">1.1.1. Numerai Classic: Version 1 specific<a class="anchor-link" href="#1.1.1.-Numerai-Classic:-Version-1-specific"> </a></h4><p>Preprocessors that only work for version 1 (legacy data).
When using version 1 preprocessor it is recommended that the input <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> has <code>version</code> in its metadata.
This avoids using version 1 preprocessors on version 2 data and confusing error messages.</p>
<p>As a new user we recommend to start modeling the version 2 data and avoid version 1.
The preprocessors below are there for legacy and compatibility reasons.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.1.1.1.-GroupStatsPreProcessor">1.1.1.1. GroupStatsPreProcessor<a class="anchor-link" href="#1.1.1.1.-GroupStatsPreProcessor"> </a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The version 1 legacy data has 6 groups of features which allows us to calculate aggregate features.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GroupStatsPreProcessor" class="doc_header"><code>class</code> <code>GroupStatsPreProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L89" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GroupStatsPreProcessor</code>(<strong><code>groups</code></strong>:<code>list</code>=<em><code>None</code></em>) :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<p>WARNING: Only supported for Version 1 (legacy) data.
Calculate group statistics for all data groups.
:param groups: Groups to create features for. All groups by default.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="21d58b90-8f26-4e20-8d21-707bbb10138f"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#21d58b90-8f26-4e20-8d21-707bbb10138f');

            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "#export\nclass GroupStatsPreProcessor(BaseProcessor):\n    \"\"\"\n    WARNING: Only supported for Version 1 (legacy) data.\n    Calculate group statistics for all data groups.\n    :param groups: Groups to create features for. All groups by default.\n    \"\"\"\n    def __init__(self, groups: list = None):\n        super().__init__()\n        self.all_groups = [\"intelligence\", \"wisdom\", \"charisma\",\n                           \"dexterity\", \"strength\", \"constitution\"]\n        self.group_names = groups if groups else self.all_groups\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        \"\"\" Check validity and add group features. \"\"\"\n        self._check_data_validity(dataf=dataf)\n        dataf = dataf.pipe(self._add_group_features)\n        return NumerFrame(dataf)\n\n    def _add_group_features(self, dataf: pd.DataFrame) -> pd.DataFrame:\n        \"\"\" Mean, standard deviation and skew for each group. \"\"\"\n        for group in self.group_names:\n            cols = [col for col in dataf.columns if group in col]\n            dataf[f\"feature_{group}_mean\"] = dataf[cols].mean(axis=1)\n            dataf[f\"feature_{group}_std\"] = dataf[cols].std(axis=1)\n            dataf[f\"feature_{group}_skew\"] = dataf[cols].skew(axis=1)\n        return dataf\n\n    def _check_data_validity(self, dataf: NumerFrame):\n        \"\"\" Make sure this is only used for version 1 data. \"\"\"\n        assert hasattr(dataf.meta, 'version'), f\"Version should be specified for '{self.__class__.__name__}' This Preprocessor will only work on version 1 data.\"\n        assert getattr(dataf.meta, 'version') == 1, f\"'{self.__class__.__name__}' only works on version 1 data. Got version: '{getattr(dataf.meta, 'version')}'.\"";
                var nbb_formatted_code = "# export\nclass GroupStatsPreProcessor(BaseProcessor):\n    \"\"\"\n    WARNING: Only supported for Version 1 (legacy) data.\n    Calculate group statistics for all data groups.\n    :param groups: Groups to create features for. All groups by default.\n    \"\"\"\n\n    def __init__(self, groups: list = None):\n        super().__init__()\n        self.all_groups = [\n            \"intelligence\",\n            \"wisdom\",\n            \"charisma\",\n            \"dexterity\",\n            \"strength\",\n            \"constitution\",\n        ]\n        self.group_names = groups if groups else self.all_groups\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        \"\"\"Check validity and add group features.\"\"\"\n        self._check_data_validity(dataf=dataf)\n        dataf = dataf.pipe(self._add_group_features)\n        return NumerFrame(dataf)\n\n    def _add_group_features(self, dataf: pd.DataFrame) -> pd.DataFrame:\n        \"\"\"Mean, standard deviation and skew for each group.\"\"\"\n        for group in self.group_names:\n            cols = [col for col in dataf.columns if group in col]\n            dataf[f\"feature_{group}_mean\"] = dataf[cols].mean(axis=1)\n            dataf[f\"feature_{group}_std\"] = dataf[cols].std(axis=1)\n            dataf[f\"feature_{group}_skew\"] = dataf[cols].skew(axis=1)\n        return dataf\n\n    def _check_data_validity(self, dataf: NumerFrame):\n        \"\"\"Make sure this is only used for version 1 data.\"\"\"\n        assert hasattr(\n            dataf.meta, \"version\"\n        ), f\"Version should be specified for '{self.__class__.__name__}' This Preprocessor will only work on version 1 data.\"\n        assert (\n            getattr(dataf.meta, \"version\") == 1\n        ), f\"'{self.__class__.__name__}' only works on version 1 data. Got version: '{getattr(dataf.meta, 'version')}'.\"";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="s2">&quot;test_assets/mini_numerai_version_1_data.csv&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">group_features_dataset</span> <span class="o">=</span> <span class="n">GroupStatsPreProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">group_features_dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">group_features_dataset</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">GroupStatsPreProcessor</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">332</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">024888</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="f44b7de3-b19f-4790-9240-cea5ebcb4e28"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f44b7de3-b19f-4790-9240-cea5ebcb4e28');

            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "dataset = create_numerframe(\"test_assets/mini_numerai_version_1_data.csv\", metadata={\"version\": 1})\ngroup_features_dataset = GroupStatsPreProcessor().transform(dataset)\ngroup_features_dataset.head(2)\nassert group_features_dataset.meta.version == 1";
                var nbb_formatted_code = "dataset = create_numerframe(\n    \"test_assets/mini_numerai_version_1_data.csv\", metadata={\"version\": 1}\n)\ngroup_features_dataset = GroupStatsPreProcessor().transform(dataset)\ngroup_features_dataset.head(2)\nassert group_features_dataset.meta.version == 1";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_cols</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;feature_intelligence_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_intelligence_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_intelligence_skew&#39;</span><span class="p">,</span>
             <span class="s1">&#39;feature_wisdom_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_wisdom_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_wisdom_skew&#39;</span><span class="p">,</span>
             <span class="s1">&#39;feature_charisma_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_charisma_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_charisma_skew&#39;</span><span class="p">,</span>
             <span class="s1">&#39;feature_dexterity_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_dexterity_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_dexterity_skew&#39;</span><span class="p">,</span>
             <span class="s1">&#39;feature_strength_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_strength_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_strength_skew&#39;</span><span class="p">,</span>
             <span class="s1">&#39;feature_constitution_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_constitution_std&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_constitution_skew&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">group_features_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span>
<span class="n">group_features_dataset</span><span class="o">.</span><span class="n">get_feature_data</span><span class="p">[</span><span class="n">new_cols</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature_intelligence_mean</th>
      <th>feature_intelligence_std</th>
      <th>feature_intelligence_skew</th>
      <th>feature_wisdom_mean</th>
      <th>feature_wisdom_std</th>
      <th>feature_wisdom_skew</th>
      <th>feature_charisma_mean</th>
      <th>feature_charisma_std</th>
      <th>feature_charisma_skew</th>
      <th>feature_dexterity_mean</th>
      <th>feature_dexterity_std</th>
      <th>feature_dexterity_skew</th>
      <th>feature_strength_mean</th>
      <th>feature_strength_std</th>
      <th>feature_strength_skew</th>
      <th>feature_constitution_mean</th>
      <th>feature_constitution_std</th>
      <th>feature_constitution_skew</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.333333</td>
      <td>0.246183</td>
      <td>0.558528</td>
      <td>0.668478</td>
      <td>0.236022</td>
      <td>-0.115082</td>
      <td>0.438953</td>
      <td>0.259910</td>
      <td>-0.004783</td>
      <td>0.696429</td>
      <td>0.200446</td>
      <td>-0.607620</td>
      <td>0.480263</td>
      <td>0.292829</td>
      <td>-0.372064</td>
      <td>0.427632</td>
      <td>0.27572</td>
      <td>0.276155</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.208333</td>
      <td>0.234359</td>
      <td>0.382554</td>
      <td>0.559783</td>
      <td>0.358177</td>
      <td>-0.062362</td>
      <td>0.485465</td>
      <td>0.252501</td>
      <td>-0.021737</td>
      <td>0.267857</td>
      <td>0.249312</td>
      <td>0.382267</td>
      <td>0.407895</td>
      <td>0.309866</td>
      <td>0.220625</td>
      <td>0.644737</td>
      <td>0.33408</td>
      <td>-0.794938</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">




<div id="d45ea76f-cd25-4ec2-a1fe-5b5e0dea5d06"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d45ea76f-cd25-4ec2-a1fe-5b5e0dea5d06');

            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "new_cols =  ['feature_intelligence_mean', 'feature_intelligence_std', 'feature_intelligence_skew',\n             'feature_wisdom_mean', 'feature_wisdom_std', 'feature_wisdom_skew',\n             'feature_charisma_mean', 'feature_charisma_std', 'feature_charisma_skew',\n             'feature_dexterity_mean', 'feature_dexterity_std', 'feature_dexterity_skew',\n             'feature_strength_mean', 'feature_strength_std', 'feature_strength_skew',\n             'feature_constitution_mean', 'feature_constitution_std', 'feature_constitution_skew']\nassert set(group_features_dataset.columns).intersection(new_cols)\ngroup_features_dataset.get_feature_data[new_cols].head(2)";
                var nbb_formatted_code = "new_cols = [\n    \"feature_intelligence_mean\",\n    \"feature_intelligence_std\",\n    \"feature_intelligence_skew\",\n    \"feature_wisdom_mean\",\n    \"feature_wisdom_std\",\n    \"feature_wisdom_skew\",\n    \"feature_charisma_mean\",\n    \"feature_charisma_std\",\n    \"feature_charisma_skew\",\n    \"feature_dexterity_mean\",\n    \"feature_dexterity_std\",\n    \"feature_dexterity_skew\",\n    \"feature_strength_mean\",\n    \"feature_strength_std\",\n    \"feature_strength_skew\",\n    \"feature_constitution_mean\",\n    \"feature_constitution_std\",\n    \"feature_constitution_skew\",\n]\nassert set(group_features_dataset.columns).intersection(new_cols)\ngroup_features_dataset.get_feature_data[new_cols].head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/numerai_blocks/preprocessing.html#GroupStatsPreProcessor"><code>GroupStatsPreProcessor</code></a> should break if <code>version != 1</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_invalid_version</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">NumerFrame</span><span class="p">):</span>
    <span class="n">copied_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">copied_dataset</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">GroupStatsPreProcessor</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">copied_dataset</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">test_invalid_version</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">✅ Finished step <span style="font-weight: bold">GroupStatsPreProcessor</span>. Output <span style="color: #808000; text-decoration-color: #808000">shape</span>=<span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">332</span><span style="font-weight: bold">)</span>. Time taken for step: 
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">0:00:00</span><span style="color: #000080; text-decoration-color: #000080">.</span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">019115</span>. ✅
</pre>

</div>

</div>

<div class="output_area">




<div id="e08e505e-2245-4f89-889c-a18d2b445e82"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e08e505e-2245-4f89-889c-a18d2b445e82');

            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "def test_invalid_version(dataset: NumerFrame):\n    copied_dataset = dataset.copy()\n    copied_dataset.version = 2\n    try:\n        GroupStatsPreProcessor().transform(copied_dataset)\n    except AssertionError:\n        return True\n    return False\n\ntest_invalid_version(dataset);";
                var nbb_formatted_code = "def test_invalid_version(dataset: NumerFrame):\n    copied_dataset = dataset.copy()\n    copied_dataset.version = 2\n    try:\n        GroupStatsPreProcessor().transform(copied_dataset)\n    except AssertionError:\n        return True\n    return False\n\n\ntest_invalid_version(dataset)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="1.1.2.-Numerai-Classic:-Version-2-specific">1.1.2. Numerai Classic: Version 2 specific<a class="anchor-link" href="#1.1.2.-Numerai-Classic:-Version-2-specific"> </a></h4><p>Preprocessors that are only compatible with version 2 data. If the preprocessor is agnostic to Numerai Classic version implement under heading 1.1.0.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.4.-Signals-specific">1.4. Signals specific<a class="anchor-link" href="#1.4.-Signals-specific"> </a></h3><p>Preprocessors that are specific to Numerai Signals.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Custom-preprocessors">2. Custom preprocessors<a class="anchor-link" href="#2.-Custom-preprocessors"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are an almost unlimited number of ways to preprocess (selection, engineering and manipulation). We have only scratched the surface with the preprocessors currently implemented in <code>numerai-blocks</code>. We invite the Numerai community to develop Numerai Classic and Signals preprocessors for <code>numerai-blocks</code>.</p>
<p>A new Preprocessor should inherit from <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a> and implement a <code>transform</code> method. For efficient implementation we recommend you use <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> functionality for preprocessing, but if this is not relevant for your application, the Preprocessor can also support a Pandas DataFrame as input as long as it returns a <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a>. This ensures that the Preprocessor still works within a full <code>numerai-blocks</code> pipeline. A template for new Preprocessors is given below.</p>
<p>To enable fancy logging output. Add the <code>@display_processor_info</code> decorator to the <code>transform</code> method.</p>
<p>Note that arbitrary metadata stored by <a href="/numerai_blocks/numerframe.html#NumerFrame"><code>NumerFrame</code></a> can be added or changed in a preprocessing step.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AwesomePreProcessor" class="doc_header"><code>class</code> <code>AwesomePreProcessor</code><a href="https://github.com/crowdcent/numerai_blocks/tree/main/numerai_blocks/preprocessing.py#L123" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AwesomePreProcessor</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/numerai_blocks/preprocessing.html#BaseProcessor"><code>BaseProcessor</code></a></p>
</blockquote>
<ul>
<li>TEMPLATE -
Do some awesome preprocessing.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="da3e336a-e667-4a01-a369-8caee80280e9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#da3e336a-e667-4a01-a369-8caee80280e9');

            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "# export\nclass AwesomePreProcessor(BaseProcessor):\n    \"\"\"\n    - TEMPLATE -\n    Do some awesome preprocessing.\n    \"\"\"\n    def __init__(self, *args, **kwargs):\n        super().__init__()\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        # Do processing\n        ...\n        # Parse all contents of NumerFrame to the next pipeline step\n        return NumerFrame(dataf)";
                var nbb_formatted_code = "# export\nclass AwesomePreProcessor(BaseProcessor):\n    \"\"\"\n    - TEMPLATE -\n    Do some awesome preprocessing.\n    \"\"\"\n\n    def __init__(self, *args, **kwargs):\n        super().__init__()\n\n    @display_processor_info\n    def transform(self, dataf: NumerFrame, *args, **kwargs) -> NumerFrame:\n        # Do processing\n        ...\n        # Parse all contents of NumerFrame to the next pipeline step\n        return NumerFrame(dataf)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
</div>
 

