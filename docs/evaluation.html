---

title: Evaluation


keywords: fastai
sidebar: home_sidebar

summary: "Compute evaluation metrics."
description: "Compute evaluation metrics."
nb_path: "nbs/07_evaluation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/07_evaluation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h2><p>This section provides evaluation schemes for both Numerai Classic and Signals.
The <code>Evaluator</code> takes a <a href="/numerbloxnumerframe.html#NumerFrame"><code>NumerFrame</code></a> as input and returns a Pandas DataFrame containing metrics for each given prediction column.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="0.-Base">0. Base<a class="anchor-link" href="#0.-Base"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/numerbloxevaluation.html#BaseEvaluator"><code>BaseEvaluator</code></a> implements all the evaluation logic that is common for Numerai Classic and Signals. This includes:</p>
<ul>
<li>Mean, Standard Deviation and Sharpe for era returns.</li>
<li>Max drawdown</li>
<li>Annual Percentage Yield (APY)</li>
<li>Mean, Standard deviation and Sharpe for <a href="https://docs.numer.ai/tournament/metamodel-contribution">MMC (Meta Model Contribution)</a> returns.</li>
<li>Correlation with example predictions</li>
<li>Max <a href="https://forum.numer.ai/t/model-diagnostics-feature-exposure/899">feature exposure</a></li>
<li><a href="https://docs.numer.ai/tournament/feature-neutral-correlation">Feature Neutral Mean (FNC)</a>, Standard deviation and Sharpe</li>
<li><a href="https://forum.numer.ai/t/true-contribution-details/5128/4">Exposure Dissimilarity</a></li>
<li>Mean, Standard Deviation and Sharpe for TB200 (Buy top 200 stocks and sell bottom 200 stocks).</li>
<li>Mean, Standard Deviation and Sharpe for TB500 (Buy top 500 stocks and sell bottom 500 stocks).</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseEvaluator" class="doc_header"><code>class</code> <code>BaseEvaluator</code><a href="https://github.com/crowdcent/numerblox/tree/master/numerblox/evaluation.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseEvaluator</code>(<strong><code>era_col</code></strong>:<code>str</code>=<em><code>'era'</code></em>, <strong><code>fast_mode</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Evaluation functionality that is relevant for both
Numerai Classic and Numerai Signals.</p>
<p>:param era_col: Column name pointing to eras.</p>
<p>Most commonly "era" for Numerai Classic and "friday_date" for Numerai Signals.</p>
<p>:param fast_mode: Will skip compute intensive metrics if set to True,
namely max_exposure, feature neutral mean, TB200 and TB500.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="74639e0f-9a85-463a-a1f0-f5c983d52d14"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#74639e0f-9a85-463a-a1f0-f5c983d52d14');

            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "# export\nclass BaseEvaluator:\n    \"\"\"\n    Evaluation functionality that is relevant for both\n    Numerai Classic and Numerai Signals.\n\n    :param era_col: Column name pointing to eras. \\n\n    Most commonly \"era\" for Numerai Classic and \"friday_date\" for Numerai Signals. \\n\n    :param fast_mode: Will skip compute intensive metrics if set to True,\n    namely max_exposure, feature neutral mean, TB200 and TB500.\n    \"\"\"\n    def __init__(self, era_col: str = \"era\", fast_mode=False):\n        self.era_col = era_col\n        self.fast_mode = fast_mode\n\n    def full_evaluation(\n        self,\n        dataf: NumerFrame,\n        example_col: str,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n    ) -> pd.DataFrame:\n        \"\"\"\n        Perform evaluation for each prediction column in the NumerFrame\n        against give target and example prediction column.\n        \"\"\"\n        val_stats = pd.DataFrame()\n        dataf = dataf.fillna(0.5)\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n        for col in tqdm(pred_cols, desc=\"Evaluation: \"):\n            col_stats = self.evaluation_one_col(\n                dataf=dataf,\n                pred_col=col,\n                target_col=target_col,\n                example_col=example_col,\n            )\n            val_stats = pd.concat([val_stats, col_stats], axis=0)\n        return val_stats\n\n    def evaluation_one_col(\n        self,\n        dataf: Union[pd.DataFrame, NumerFrame],\n        pred_col: str,\n        target_col: str,\n        example_col: str,\n    ):\n        \"\"\"\n        Perform evaluation for one prediction column\n        against given target and example prediction column.\n        \"\"\"\n        col_stats = pd.DataFrame()\n        # Compute stats\n        val_corrs = self.per_era_corrs(\n            dataf=dataf, pred_col=pred_col, target_col=target_col\n        )\n        mean, std, sharpe = self.mean_std_sharpe(era_corrs=val_corrs)\n        max_drawdown = self.max_drawdown(era_corrs=val_corrs)\n        apy = self.apy(era_corrs=val_corrs)\n        example_corr = self.example_correlation(\n            dataf=dataf, pred_col=pred_col, example_col=example_col\n        )\n        mmc_mean, mmc_std, mmc_sharpe = self.mmc(\n            dataf=dataf,\n            pred_col=pred_col,\n            target_col=target_col,\n            example_col=example_col,\n        )\n        ex_diss = self.exposure_dissimilarity(\n            dataf=dataf, pred_col=pred_col, example_col=example_col\n        )\n\n        col_stats.loc[pred_col, \"target\"] = target_col\n        col_stats.loc[pred_col, \"mean\"] = mean\n        col_stats.loc[pred_col, \"std\"] = std\n        col_stats.loc[pred_col, \"sharpe\"] = sharpe\n        col_stats.loc[pred_col, \"max_drawdown\"] = max_drawdown\n        col_stats.loc[pred_col, \"apy\"] = apy\n        col_stats.loc[pred_col, \"mmc_mean\"] = mmc_mean\n        col_stats.loc[pred_col, \"mmc_std\"] = mmc_std\n        col_stats.loc[pred_col, \"mmc_sharpe\"] = mmc_sharpe\n        col_stats.loc[pred_col, \"corr_with_example_preds\"] = example_corr\n        col_stats.loc[pred_col, \"exposure_dissimilarity\"] = ex_diss\n\n        # Compute intensive stats\n        if not self.fast_mode:\n            max_feature_exposure = self.max_feature_exposure(\n                dataf=dataf, pred_col=pred_col\n            )\n            fn_mean, fn_std, fn_sharpe = self.feature_neutral_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col\n            )\n            tb200_mean, tb200_std, tb200_sharpe = self.tbx_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col, tb=200\n            )\n            tb500_mean, tb500_std, tb500_sharpe = self.tbx_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col, tb=500\n            )\n\n            col_stats.loc[pred_col, \"max_feature_exposure\"] = max_feature_exposure\n            col_stats.loc[pred_col, \"feature_neutral_mean\"] = fn_mean\n            col_stats.loc[pred_col, \"feature_neutral_std\"] = fn_std\n            col_stats.loc[pred_col, \"feature_neutral_sharpe\"] = fn_sharpe\n            col_stats.loc[pred_col, \"tb200_mean\"] = tb200_mean\n            col_stats.loc[pred_col, \"tb200_std\"] = tb200_std\n            col_stats.loc[pred_col, \"tb200_sharpe\"] = tb200_sharpe\n            col_stats.loc[pred_col, \"tb500_mean\"] = tb500_mean\n            col_stats.loc[pred_col, \"tb500_std\"] = tb500_std\n            col_stats.loc[pred_col, \"tb500_sharpe\"] = tb500_sharpe\n        return col_stats\n\n    def per_era_corrs(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str\n    ) -> pd.Series:\n        \"\"\"Correlation between prediction and target for each era.\"\"\"\n        return dataf.groupby(dataf[self.era_col]).apply(\n            lambda d: self._normalize_uniform(d[pred_col].fillna(0.5)).corr(\n                d[target_col]\n            )\n        )\n\n    def mean_std_sharpe(\n        self, era_corrs: pd.Series\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Average, standard deviation and Sharpe ratio for\n        correlations per era.\n        \"\"\"\n        mean = pd.Series(era_corrs.mean()).item()\n        std = pd.Series(era_corrs.std(ddof=0)).item()\n        sharpe = mean / std\n        return mean, std, sharpe\n\n    @staticmethod\n    def max_drawdown(era_corrs: pd.Series) -> np.float64:\n        \"\"\"Maximum drawdown per era.\"\"\"\n        # Arbitrarily large window\n        rolling_max = (\n            (era_corrs + 1).cumprod().rolling(window=9000, min_periods=1).max()\n        )\n        daily_value = (era_corrs + 1).cumprod()\n        max_drawdown = -((rolling_max - daily_value) / rolling_max).max()\n        return max_drawdown\n\n    @staticmethod\n    def apy(era_corrs: pd.Series, stake_compounding_lag: int = 4) -> np.float64:\n        \"\"\"\n        Annual percentage yield.\n        :param era_corrs: Correlation scores by era\n        :param stake_compounding_lag: Compounding lag for Numerai rounds (4 for Numerai Classic)\n        \"\"\"\n        payout_scores = era_corrs.clip(-0.25, 0.25)\n        payout_daily_value = (payout_scores + 1).cumprod()\n        apy = (\n            ((payout_daily_value.dropna().iloc[-1]) ** (1 / len(payout_scores)))\n            ** (\n                52 - stake_compounding_lag\n            )  # 52 weeks of compounding minus n for stake compounding lag\n            - 1\n        ) * 100\n        return apy\n\n    def example_correlation(\n        self, dataf: Union[pd.DataFrame, NumerFrame], pred_col: str, example_col: str\n    ):\n        \"\"\"Correlations with example predictions.\"\"\"\n        return self.per_era_corrs(\n            dataf=dataf,\n            pred_col=pred_col,\n            target_col=example_col,\n        ).mean()\n\n    def max_feature_exposure(\n        self, dataf: Union[pd.DataFrame, NumerFrame], pred_col: str\n    ) -> np.float64:\n        \"\"\"Maximum exposure over all features.\"\"\"\n        max_per_era = dataf.groupby(self.era_col).apply(\n            lambda d: d[dataf.feature_cols].corrwith(d[pred_col]).abs().max()\n        )\n        max_feature_exposure = max_per_era.mean(skipna=True)\n        return max_feature_exposure\n\n    def feature_neutral_mean_std_sharpe(\n        self, dataf: Union[pd.DataFrame, NumerFrame], pred_col: str, target_col: str, feature_names: list = None\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Feature neutralized mean performance.\n        More info: https://docs.numer.ai/tournament/feature-neutral-correlation\n        \"\"\"\n        fn = FeatureNeutralizer(pred_name=pred_col,\n                                feature_names=feature_names,\n                                proportion=1.0)\n        neutralized_dataf = fn(dataf=dataf)\n        neutral_corrs = self.per_era_corrs(\n            dataf=neutralized_dataf,\n            pred_col=f\"{pred_col}_neutralized_1.0\",\n            target_col=target_col,\n        )\n        mean, std, sharpe = self.mean_std_sharpe(era_corrs=neutral_corrs)\n        return mean, std, sharpe\n\n    def tbx_mean_std_sharpe(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str, tb: int = 200\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Calculate Mean, Standard deviation and Sharpe ratio\n        when we focus on the x top and x bottom predictions.\n        :param tb: How many of top and bottom predictions to focus on.\n        TB200 and TB500 are the most common situations.\n        \"\"\"\n        tb_val_corrs = self._score_by_date(\n            dataf=dataf, columns=[pred_col], target=target_col, tb=tb\n        )\n        return self.mean_std_sharpe(era_corrs=tb_val_corrs)\n\n    def mmc(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str, example_col: str\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        MMC Mean, standard deviation and Sharpe ratio.\n        More info: https://docs.numer.ai/tournament/metamodel-contribution\n        \"\"\"\n        mmc_scores = []\n        corr_scores = []\n        for _, x in dataf.groupby(self.era_col):\n            series = self._neutralize_series(\n                self._normalize_uniform(x[pred_col]), (x[example_col])\n            )\n            mmc_scores.append(np.cov(series, x[target_col])[0, 1] / (0.29 ** 2))\n            corr_scores.append(self._normalize_uniform(x[pred_col]).corr(x[target_col]))\n\n        val_mmc_mean = np.mean(mmc_scores)\n        val_mmc_std = np.std(mmc_scores)\n        corr_plus_mmcs = [c + m for c, m in zip(corr_scores, mmc_scores)]\n        corr_plus_mmc_sharpe = np.mean(corr_plus_mmcs) / np.std(corr_plus_mmcs)\n        return val_mmc_mean, val_mmc_std, corr_plus_mmc_sharpe\n\n    def exposure_dissimilarity(self, dataf: pd.DataFrame, pred_col: str, example_col: str) -> np.float32:\n        \"\"\"\n        Model pattern of feature exposure to the example column.\n        See TC details forum post: https://forum.numer.ai/t/true-contribution-details/5128/4\n\n       1. Calculate the correlation of a user\u2019s prediction and the example prediction with each of the features to form two vectors U and E.\n       2. Take the dot product of U and E divided by the dot product of E with E. This measures how similar the pattern of exposures are and is normalized to be 1 if U is identical to E.\n       3. Subtract from 1 to form a dissimilarity metric where 0 means the same exposure pattern as example predictions, positive values indicate differing patterns of exposure and negative values indicate similar patterns but even higher exposures. Note that models with 0 feature exposure will have a dissimilarity value of 1.\n        Exposure Dissimilarity: 1 - U\u2022E/E\u2022E\n        \"\"\"\n        U = []\n        E = []\n        for feat in tqdm(dataf.feature_cols, desc=\"Exposure Dissimilarity correlations\"):\n            corr_pred = dataf[feat].corr(dataf[pred_col], method='spearman')\n            corr_example = dataf[feat].corr(dataf[example_col], method='spearman')\n            U.append(corr_pred)\n            E.append(corr_example)\n        exp_dis = 1 - (U @ E) / (E @ E)\n        assert 0. <= exp_dis <= 1., \"Check formula. Exposure dissimilarity should be between 0 and 1.\"\n        return exp_dis\n\n\n    @staticmethod\n    def _neutralize_series(series, by, proportion=1.0):\n        scores = series.values.reshape(-1, 1)\n        exposures = by.values.reshape(-1, 1)\n\n        # this line makes series neutral to a constant column so that it's centered and for sure gets corr 0 with exposures\n        exposures = np.hstack(\n            (exposures, np.array([np.mean(series)] * len(exposures)).reshape(-1, 1))\n        )\n\n        correction = proportion * (\n            exposures.dot(np.linalg.lstsq(exposures, scores, rcond=None)[0])\n        )\n        corrected_scores = scores - correction\n        neutralized = pd.Series(corrected_scores.ravel(), index=series.index)\n        return neutralized\n\n    def _score_by_date(\n        self, dataf: pd.DataFrame, columns: list, target: str, tb: int = None\n    ):\n        \"\"\"\n        Get era correlation based on given TB (x top and bottom predictions).\n        :param tb: How many of top and bottom predictions to focus on.\n        TB200 is the most common situation.\n        \"\"\"\n        unique_eras = dataf[self.era_col].unique()\n        computed = []\n        for u in unique_eras:\n            df_era = dataf[dataf[self.era_col] == u]\n            era_pred = np.float64(df_era[columns].values.T)\n            era_target = np.float64(df_era[target].values.T)\n\n            if tb is None:\n                ccs = np.corrcoef(era_target, era_pred)[0, 1:]\n            else:\n                tbidx = np.argsort(era_pred, axis=1)\n                tbidx = np.concatenate([tbidx[:, :tb], tbidx[:, -tb:]], axis=1)\n                ccs = [\n                    np.corrcoef(era_target[idx], pred[idx])[0, 1]\n                    for idx, pred in zip(tbidx, era_pred)\n                ]\n                ccs = np.array(ccs)\n            computed.append(ccs)\n        return pd.DataFrame(\n            np.array(computed), columns=columns, index=dataf[self.era_col].unique()\n        )\n\n    @staticmethod\n    def _normalize_uniform(df: pd.DataFrame) -> pd.Series:\n        \"\"\"Normalize predictions uniformly using ranks.\"\"\"\n        x = (df.rank(method=\"first\") - 0.5) / len(df)\n        return pd.Series(x, index=df.index)\n\n    def plot_correlations(\n        self,\n        dataf: NumerFrame,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n        roll_mean: int = 20,\n    ):\n        \"\"\"\n        Plot per era correlations over time.\n        :param roll_mean: How many eras should be averaged to compute a rolling score.\n        \"\"\"\n        validation_by_eras = pd.DataFrame()\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n        for pred_col in pred_cols:\n            per_era_corrs = self.per_era_corrs(\n                dataf, pred_col=pred_col, target_col=target_col\n            )\n            validation_by_eras.loc[:, pred_col] = per_era_corrs\n\n        validation_by_eras.rolling(roll_mean).mean().plot(\n            kind=\"line\",\n            marker=\"o\",\n            ms=4,\n            title=f\"Rolling Per Era Correlation Mean (rolling window size: {roll_mean})\",\n            figsize=(15, 5),\n        )\n        plt.legend(\n            loc=\"upper center\",\n            bbox_to_anchor=(0.5, -0.05),\n            fancybox=True,\n            shadow=True,\n            ncol=1,\n        )\n        plt.axhline(y=0.0, color=\"r\", linestyle=\"--\")\n        plt.show()\n\n        validation_by_eras.cumsum().plot(\n            title=\"Cumulative Sum of Era Correlations\", figsize=(15, 5)\n        )\n        plt.legend(\n            loc=\"upper center\",\n            bbox_to_anchor=(0.5, -0.05),\n            fancybox=True,\n            shadow=True,\n            ncol=1,\n        )\n        plt.axhline(y=0.0, color=\"r\", linestyle=\"--\")\n        plt.show()\n        return None";
                var nbb_formatted_code = "# export\nclass BaseEvaluator:\n    \"\"\"\n    Evaluation functionality that is relevant for both\n    Numerai Classic and Numerai Signals.\n\n    :param era_col: Column name pointing to eras. \\n\n    Most commonly \"era\" for Numerai Classic and \"friday_date\" for Numerai Signals. \\n\n    :param fast_mode: Will skip compute intensive metrics if set to True,\n    namely max_exposure, feature neutral mean, TB200 and TB500.\n    \"\"\"\n\n    def __init__(self, era_col: str = \"era\", fast_mode=False):\n        self.era_col = era_col\n        self.fast_mode = fast_mode\n\n    def full_evaluation(\n        self,\n        dataf: NumerFrame,\n        example_col: str,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n    ) -> pd.DataFrame:\n        \"\"\"\n        Perform evaluation for each prediction column in the NumerFrame\n        against give target and example prediction column.\n        \"\"\"\n        val_stats = pd.DataFrame()\n        dataf = dataf.fillna(0.5)\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n        for col in tqdm(pred_cols, desc=\"Evaluation: \"):\n            col_stats = self.evaluation_one_col(\n                dataf=dataf,\n                pred_col=col,\n                target_col=target_col,\n                example_col=example_col,\n            )\n            val_stats = pd.concat([val_stats, col_stats], axis=0)\n        return val_stats\n\n    def evaluation_one_col(\n        self,\n        dataf: Union[pd.DataFrame, NumerFrame],\n        pred_col: str,\n        target_col: str,\n        example_col: str,\n    ):\n        \"\"\"\n        Perform evaluation for one prediction column\n        against given target and example prediction column.\n        \"\"\"\n        col_stats = pd.DataFrame()\n        # Compute stats\n        val_corrs = self.per_era_corrs(\n            dataf=dataf, pred_col=pred_col, target_col=target_col\n        )\n        mean, std, sharpe = self.mean_std_sharpe(era_corrs=val_corrs)\n        max_drawdown = self.max_drawdown(era_corrs=val_corrs)\n        apy = self.apy(era_corrs=val_corrs)\n        example_corr = self.example_correlation(\n            dataf=dataf, pred_col=pred_col, example_col=example_col\n        )\n        mmc_mean, mmc_std, mmc_sharpe = self.mmc(\n            dataf=dataf,\n            pred_col=pred_col,\n            target_col=target_col,\n            example_col=example_col,\n        )\n        ex_diss = self.exposure_dissimilarity(\n            dataf=dataf, pred_col=pred_col, example_col=example_col\n        )\n\n        col_stats.loc[pred_col, \"target\"] = target_col\n        col_stats.loc[pred_col, \"mean\"] = mean\n        col_stats.loc[pred_col, \"std\"] = std\n        col_stats.loc[pred_col, \"sharpe\"] = sharpe\n        col_stats.loc[pred_col, \"max_drawdown\"] = max_drawdown\n        col_stats.loc[pred_col, \"apy\"] = apy\n        col_stats.loc[pred_col, \"mmc_mean\"] = mmc_mean\n        col_stats.loc[pred_col, \"mmc_std\"] = mmc_std\n        col_stats.loc[pred_col, \"mmc_sharpe\"] = mmc_sharpe\n        col_stats.loc[pred_col, \"corr_with_example_preds\"] = example_corr\n        col_stats.loc[pred_col, \"exposure_dissimilarity\"] = ex_diss\n\n        # Compute intensive stats\n        if not self.fast_mode:\n            max_feature_exposure = self.max_feature_exposure(\n                dataf=dataf, pred_col=pred_col\n            )\n            fn_mean, fn_std, fn_sharpe = self.feature_neutral_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col\n            )\n            tb200_mean, tb200_std, tb200_sharpe = self.tbx_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col, tb=200\n            )\n            tb500_mean, tb500_std, tb500_sharpe = self.tbx_mean_std_sharpe(\n                dataf=dataf, pred_col=pred_col, target_col=target_col, tb=500\n            )\n\n            col_stats.loc[pred_col, \"max_feature_exposure\"] = max_feature_exposure\n            col_stats.loc[pred_col, \"feature_neutral_mean\"] = fn_mean\n            col_stats.loc[pred_col, \"feature_neutral_std\"] = fn_std\n            col_stats.loc[pred_col, \"feature_neutral_sharpe\"] = fn_sharpe\n            col_stats.loc[pred_col, \"tb200_mean\"] = tb200_mean\n            col_stats.loc[pred_col, \"tb200_std\"] = tb200_std\n            col_stats.loc[pred_col, \"tb200_sharpe\"] = tb200_sharpe\n            col_stats.loc[pred_col, \"tb500_mean\"] = tb500_mean\n            col_stats.loc[pred_col, \"tb500_std\"] = tb500_std\n            col_stats.loc[pred_col, \"tb500_sharpe\"] = tb500_sharpe\n        return col_stats\n\n    def per_era_corrs(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str\n    ) -> pd.Series:\n        \"\"\"Correlation between prediction and target for each era.\"\"\"\n        return dataf.groupby(dataf[self.era_col]).apply(\n            lambda d: self._normalize_uniform(d[pred_col].fillna(0.5)).corr(\n                d[target_col]\n            )\n        )\n\n    def mean_std_sharpe(\n        self, era_corrs: pd.Series\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Average, standard deviation and Sharpe ratio for\n        correlations per era.\n        \"\"\"\n        mean = pd.Series(era_corrs.mean()).item()\n        std = pd.Series(era_corrs.std(ddof=0)).item()\n        sharpe = mean / std\n        return mean, std, sharpe\n\n    @staticmethod\n    def max_drawdown(era_corrs: pd.Series) -> np.float64:\n        \"\"\"Maximum drawdown per era.\"\"\"\n        # Arbitrarily large window\n        rolling_max = (\n            (era_corrs + 1).cumprod().rolling(window=9000, min_periods=1).max()\n        )\n        daily_value = (era_corrs + 1).cumprod()\n        max_drawdown = -((rolling_max - daily_value) / rolling_max).max()\n        return max_drawdown\n\n    @staticmethod\n    def apy(era_corrs: pd.Series, stake_compounding_lag: int = 4) -> np.float64:\n        \"\"\"\n        Annual percentage yield.\n        :param era_corrs: Correlation scores by era\n        :param stake_compounding_lag: Compounding lag for Numerai rounds (4 for Numerai Classic)\n        \"\"\"\n        payout_scores = era_corrs.clip(-0.25, 0.25)\n        payout_daily_value = (payout_scores + 1).cumprod()\n        apy = (\n            ((payout_daily_value.dropna().iloc[-1]) ** (1 / len(payout_scores)))\n            ** (\n                52 - stake_compounding_lag\n            )  # 52 weeks of compounding minus n for stake compounding lag\n            - 1\n        ) * 100\n        return apy\n\n    def example_correlation(\n        self, dataf: Union[pd.DataFrame, NumerFrame], pred_col: str, example_col: str\n    ):\n        \"\"\"Correlations with example predictions.\"\"\"\n        return self.per_era_corrs(\n            dataf=dataf,\n            pred_col=pred_col,\n            target_col=example_col,\n        ).mean()\n\n    def max_feature_exposure(\n        self, dataf: Union[pd.DataFrame, NumerFrame], pred_col: str\n    ) -> np.float64:\n        \"\"\"Maximum exposure over all features.\"\"\"\n        max_per_era = dataf.groupby(self.era_col).apply(\n            lambda d: d[dataf.feature_cols].corrwith(d[pred_col]).abs().max()\n        )\n        max_feature_exposure = max_per_era.mean(skipna=True)\n        return max_feature_exposure\n\n    def feature_neutral_mean_std_sharpe(\n        self,\n        dataf: Union[pd.DataFrame, NumerFrame],\n        pred_col: str,\n        target_col: str,\n        feature_names: list = None,\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Feature neutralized mean performance.\n        More info: https://docs.numer.ai/tournament/feature-neutral-correlation\n        \"\"\"\n        fn = FeatureNeutralizer(\n            pred_name=pred_col, feature_names=feature_names, proportion=1.0\n        )\n        neutralized_dataf = fn(dataf=dataf)\n        neutral_corrs = self.per_era_corrs(\n            dataf=neutralized_dataf,\n            pred_col=f\"{pred_col}_neutralized_1.0\",\n            target_col=target_col,\n        )\n        mean, std, sharpe = self.mean_std_sharpe(era_corrs=neutral_corrs)\n        return mean, std, sharpe\n\n    def tbx_mean_std_sharpe(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str, tb: int = 200\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        Calculate Mean, Standard deviation and Sharpe ratio\n        when we focus on the x top and x bottom predictions.\n        :param tb: How many of top and bottom predictions to focus on.\n        TB200 and TB500 are the most common situations.\n        \"\"\"\n        tb_val_corrs = self._score_by_date(\n            dataf=dataf, columns=[pred_col], target=target_col, tb=tb\n        )\n        return self.mean_std_sharpe(era_corrs=tb_val_corrs)\n\n    def mmc(\n        self, dataf: pd.DataFrame, pred_col: str, target_col: str, example_col: str\n    ) -> Tuple[np.float64, np.float64, np.float64]:\n        \"\"\"\n        MMC Mean, standard deviation and Sharpe ratio.\n        More info: https://docs.numer.ai/tournament/metamodel-contribution\n        \"\"\"\n        mmc_scores = []\n        corr_scores = []\n        for _, x in dataf.groupby(self.era_col):\n            series = self._neutralize_series(\n                self._normalize_uniform(x[pred_col]), (x[example_col])\n            )\n            mmc_scores.append(np.cov(series, x[target_col])[0, 1] / (0.29 ** 2))\n            corr_scores.append(self._normalize_uniform(x[pred_col]).corr(x[target_col]))\n\n        val_mmc_mean = np.mean(mmc_scores)\n        val_mmc_std = np.std(mmc_scores)\n        corr_plus_mmcs = [c + m for c, m in zip(corr_scores, mmc_scores)]\n        corr_plus_mmc_sharpe = np.mean(corr_plus_mmcs) / np.std(corr_plus_mmcs)\n        return val_mmc_mean, val_mmc_std, corr_plus_mmc_sharpe\n\n    def exposure_dissimilarity(\n        self, dataf: pd.DataFrame, pred_col: str, example_col: str\n    ) -> np.float32:\n        \"\"\"\n         Model pattern of feature exposure to the example column.\n         See TC details forum post: https://forum.numer.ai/t/true-contribution-details/5128/4\n\n        1. Calculate the correlation of a user\u2019s prediction and the example prediction with each of the features to form two vectors U and E.\n        2. Take the dot product of U and E divided by the dot product of E with E. This measures how similar the pattern of exposures are and is normalized to be 1 if U is identical to E.\n        3. Subtract from 1 to form a dissimilarity metric where 0 means the same exposure pattern as example predictions, positive values indicate differing patterns of exposure and negative values indicate similar patterns but even higher exposures. Note that models with 0 feature exposure will have a dissimilarity value of 1.\n         Exposure Dissimilarity: 1 - U\u2022E/E\u2022E\n        \"\"\"\n        U = []\n        E = []\n        for feat in tqdm(\n            dataf.feature_cols, desc=\"Exposure Dissimilarity correlations\"\n        ):\n            corr_pred = dataf[feat].corr(dataf[pred_col], method=\"spearman\")\n            corr_example = dataf[feat].corr(dataf[example_col], method=\"spearman\")\n            U.append(corr_pred)\n            E.append(corr_example)\n        exp_dis = 1 - (U @ E) / (E @ E)\n        assert (\n            0.0 <= exp_dis <= 1.0\n        ), \"Check formula. Exposure dissimilarity should be between 0 and 1.\"\n        return exp_dis\n\n    @staticmethod\n    def _neutralize_series(series, by, proportion=1.0):\n        scores = series.values.reshape(-1, 1)\n        exposures = by.values.reshape(-1, 1)\n\n        # this line makes series neutral to a constant column so that it's centered and for sure gets corr 0 with exposures\n        exposures = np.hstack(\n            (exposures, np.array([np.mean(series)] * len(exposures)).reshape(-1, 1))\n        )\n\n        correction = proportion * (\n            exposures.dot(np.linalg.lstsq(exposures, scores, rcond=None)[0])\n        )\n        corrected_scores = scores - correction\n        neutralized = pd.Series(corrected_scores.ravel(), index=series.index)\n        return neutralized\n\n    def _score_by_date(\n        self, dataf: pd.DataFrame, columns: list, target: str, tb: int = None\n    ):\n        \"\"\"\n        Get era correlation based on given TB (x top and bottom predictions).\n        :param tb: How many of top and bottom predictions to focus on.\n        TB200 is the most common situation.\n        \"\"\"\n        unique_eras = dataf[self.era_col].unique()\n        computed = []\n        for u in unique_eras:\n            df_era = dataf[dataf[self.era_col] == u]\n            era_pred = np.float64(df_era[columns].values.T)\n            era_target = np.float64(df_era[target].values.T)\n\n            if tb is None:\n                ccs = np.corrcoef(era_target, era_pred)[0, 1:]\n            else:\n                tbidx = np.argsort(era_pred, axis=1)\n                tbidx = np.concatenate([tbidx[:, :tb], tbidx[:, -tb:]], axis=1)\n                ccs = [\n                    np.corrcoef(era_target[idx], pred[idx])[0, 1]\n                    for idx, pred in zip(tbidx, era_pred)\n                ]\n                ccs = np.array(ccs)\n            computed.append(ccs)\n        return pd.DataFrame(\n            np.array(computed), columns=columns, index=dataf[self.era_col].unique()\n        )\n\n    @staticmethod\n    def _normalize_uniform(df: pd.DataFrame) -> pd.Series:\n        \"\"\"Normalize predictions uniformly using ranks.\"\"\"\n        x = (df.rank(method=\"first\") - 0.5) / len(df)\n        return pd.Series(x, index=df.index)\n\n    def plot_correlations(\n        self,\n        dataf: NumerFrame,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n        roll_mean: int = 20,\n    ):\n        \"\"\"\n        Plot per era correlations over time.\n        :param roll_mean: How many eras should be averaged to compute a rolling score.\n        \"\"\"\n        validation_by_eras = pd.DataFrame()\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n        for pred_col in pred_cols:\n            per_era_corrs = self.per_era_corrs(\n                dataf, pred_col=pred_col, target_col=target_col\n            )\n            validation_by_eras.loc[:, pred_col] = per_era_corrs\n\n        validation_by_eras.rolling(roll_mean).mean().plot(\n            kind=\"line\",\n            marker=\"o\",\n            ms=4,\n            title=f\"Rolling Per Era Correlation Mean (rolling window size: {roll_mean})\",\n            figsize=(15, 5),\n        )\n        plt.legend(\n            loc=\"upper center\",\n            bbox_to_anchor=(0.5, -0.05),\n            fancybox=True,\n            shadow=True,\n            ncol=1,\n        )\n        plt.axhline(y=0.0, color=\"r\", linestyle=\"--\")\n        plt.show()\n\n        validation_by_eras.cumsum().plot(\n            title=\"Cumulative Sum of Era Correlations\", figsize=(15, 5)\n        )\n        plt.legend(\n            loc=\"upper center\",\n            bbox_to_anchor=(0.5, -0.05),\n            fancybox=True,\n            shadow=True,\n            ncol=1,\n        )\n        plt.axhline(y=0.0, color=\"r\", linestyle=\"--\")\n        plt.show()\n        return None";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Numerai-Classic">1. Numerai Classic<a class="anchor-link" href="#1.-Numerai-Classic"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/numerbloxevaluation.html#NumeraiClassicEvaluator"><code>NumeraiClassicEvaluator</code></a> extends the base evaluation scheme with metrics specific to Numerai Classic.</p>
<p>Additional metrics specific to Numerai are:</p>
<ul>
<li><a href="https://forum.numer.ai/t/true-contribution-details/5128/4">Feature Neutral Mean v3 (FNCv3)</a>, Standard deviation v3 and Sharpe v3.</li>
<li>FNCv3 x Exposure Dissimilarity (Interaction between the two metrics).</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NumeraiClassicEvaluator" class="doc_header"><code>class</code> <code>NumeraiClassicEvaluator</code><a href="https://github.com/crowdcent/numerblox/tree/master/numerblox/evaluation.py#L373" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NumeraiClassicEvaluator</code>(<strong><code>era_col</code></strong>:<code>str</code>=<em><code>'era'</code></em>, <strong><code>fast_mode</code></strong>=<em><code>False</code></em>) :: <a href="/numerbloxevaluation.html#BaseEvaluator"><code>BaseEvaluator</code></a></p>
</blockquote>
<p>Evaluator for all metrics that are relevant in Numerai Classic.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="4ee36b28-9e75-4e8b-b80e-c777a9dc4c18"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#4ee36b28-9e75-4e8b-b80e-c777a9dc4c18');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "# export\nclass NumeraiClassicEvaluator(BaseEvaluator):\n    \"\"\"Evaluator for all metrics that are relevant in Numerai Classic.\"\"\"\n    def __init__(self, era_col: str = \"era\", fast_mode=False):\n        super().__init__(era_col=era_col, fast_mode=fast_mode)\n        # 420 features in medium feature set for FNC v3 calculation\n        self.v3_features = self.__load_json(\"assets/feature_sets/v3_features.json\")['medium']\n\n    def full_evaluation(\n        self,\n        dataf: NumerFrame,\n        example_col: str,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n    ) -> pd.DataFrame:\n        val_stats = pd.DataFrame()\n        dataf = dataf.fillna(0.5)\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n\n        # V3 feature check\n        valid_v3_features = set(self.v3_features).issubset(set(dataf.columns))\n        if not valid_v3_features:\n            print(\"WARNING: Not all features needed for v3 metrics are defined in DataFrame. Skipping calculation of v3 metrics.\")\n        for col in tqdm(pred_cols, desc=\"Evaluation: \"):\n            # Metrics that can be calculated for both Numerai Classic and Signals\n            col_stats = self.evaluation_one_col(\n                dataf=dataf,\n                pred_col=col,\n                target_col=target_col,\n                example_col=example_col,\n            )\n            # Numerai Classic specific metrics\n            if not self.fast_mode and valid_v3_features:\n                fnc_v3, fn_std_v3, fn_sharpe_v3 = self.feature_neutral_mean_std_sharpe(\n                    dataf=dataf, pred_col=col, target_col=target_col, feature_names=self.v3_features\n                )\n                col_stats.loc[col, \"feature_neutral_mean_v3\"] = fnc_v3\n                col_stats.loc[col, \"feature_neutral_std_v3\"] = fn_std_v3\n                col_stats.loc[col, \"feature_neutral_sharpe_v3\"] = fn_sharpe_v3\n            val_stats = pd.concat([val_stats, col_stats], axis=0)\n        return val_stats\n\n    def __load_json(self, json_path: str) -> dict:\n        with open(json_path, 'r') as f:\n            data = json.load(f)\n        return data";
                var nbb_formatted_code = "# export\nclass NumeraiClassicEvaluator(BaseEvaluator):\n    \"\"\"Evaluator for all metrics that are relevant in Numerai Classic.\"\"\"\n\n    def __init__(self, era_col: str = \"era\", fast_mode=False):\n        super().__init__(era_col=era_col, fast_mode=fast_mode)\n        # 420 features in medium feature set for FNC v3 calculation\n        self.v3_features = self.__load_json(\"assets/feature_sets/v3_features.json\")[\n            \"medium\"\n        ]\n\n    def full_evaluation(\n        self,\n        dataf: NumerFrame,\n        example_col: str,\n        pred_cols: list = None,\n        target_col: str = \"target\",\n    ) -> pd.DataFrame:\n        val_stats = pd.DataFrame()\n        dataf = dataf.fillna(0.5)\n        pred_cols = dataf.prediction_cols if not pred_cols else pred_cols\n\n        # V3 feature check\n        valid_v3_features = set(self.v3_features).issubset(set(dataf.columns))\n        if not valid_v3_features:\n            print(\n                \"WARNING: Not all features needed for v3 metrics are defined in DataFrame. Skipping calculation of v3 metrics.\"\n            )\n        for col in tqdm(pred_cols, desc=\"Evaluation: \"):\n            # Metrics that can be calculated for both Numerai Classic and Signals\n            col_stats = self.evaluation_one_col(\n                dataf=dataf,\n                pred_col=col,\n                target_col=target_col,\n                example_col=example_col,\n            )\n            # Numerai Classic specific metrics\n            if not self.fast_mode and valid_v3_features:\n                fnc_v3, fn_std_v3, fn_sharpe_v3 = self.feature_neutral_mean_std_sharpe(\n                    dataf=dataf,\n                    pred_col=col,\n                    target_col=target_col,\n                    feature_names=self.v3_features,\n                )\n                col_stats.loc[col, \"feature_neutral_mean_v3\"] = fnc_v3\n                col_stats.loc[col, \"feature_neutral_std_v3\"] = fn_std_v3\n                col_stats.loc[col, \"feature_neutral_sharpe_v3\"] = fn_sharpe_v3\n            val_stats = pd.concat([val_stats, col_stats], axis=0)\n        return val_stats\n\n    def __load_json(self, json_path: str) -> dict:\n        with open(json_path, \"r\") as f:\n            data = json.load(f)\n        return data";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Numerai-Signals">2. Numerai Signals<a class="anchor-link" href="#2.-Numerai-Signals"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/numerbloxevaluation.html#NumeraiSignalsEvaluator"><code>NumeraiSignalsEvaluator</code></a> extends the base evaluation scheme with metrics specific to Numerai Signals.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NumeraiSignalsEvaluator" class="doc_header"><code>class</code> <code>NumeraiSignalsEvaluator</code><a href="https://github.com/crowdcent/numerblox/tree/master/numerblox/evaluation.py#L420" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NumeraiSignalsEvaluator</code>(<strong><code>era_col</code></strong>:<code>str</code>=<em><code>'friday_date'</code></em>, <strong><code>fast_mode</code></strong>=<em><code>False</code></em>) :: <a href="/numerbloxevaluation.html#BaseEvaluator"><code>BaseEvaluator</code></a></p>
</blockquote>
<p>Evaluator for all metrics that are relevant in Numerai Signals.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="969a38ed-85f0-4ec6-9209-7006a3443e1c"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#969a38ed-85f0-4ec6-9209-7006a3443e1c');

            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "# export\nclass NumeraiSignalsEvaluator(BaseEvaluator):\n    \"\"\"Evaluator for all metrics that are relevant in Numerai Signals.\"\"\"\n    def __init__(self, era_col: str = \"friday_date\", fast_mode=False):\n        super().__init__(era_col=era_col, fast_mode=fast_mode)";
                var nbb_formatted_code = "# export\nclass NumeraiSignalsEvaluator(BaseEvaluator):\n    \"\"\"Evaluator for all metrics that are relevant in Numerai Signals.\"\"\"\n\n    def __init__(self, era_col: str = \"friday_date\", fast_mode=False):\n        super().__init__(era_col=era_col, fast_mode=fast_mode)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-usage">Example usage<a class="anchor-link" href="#Example-usage"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will test <a href="/numerbloxevaluation.html#NumeraiClassicEvaluator"><code>NumeraiClassicEvaluator</code></a> on version 2 evaluation data with example predictions. The baseline reference (<code>example_col</code>) will be random predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">numerblox.download</span> <span class="kn">import</span> <span class="n">NumeraiClassicDownloader</span>

<span class="n">directory</span> <span class="o">=</span> <span class="s2">&quot;eval_test_1234321/&quot;</span>
<span class="n">downloader</span> <span class="o">=</span> <span class="n">NumeraiClassicDownloader</span><span class="p">(</span><span class="n">directory_path</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">download_single_dataset</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;v3/example_validation_predictions.parquet&quot;</span><span class="p">,</span>
                                   <span class="n">dest_path</span><span class="o">=</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;example_validation_predictions.parquet&quot;</span><span class="p">)</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">download_single_dataset</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;v3/numerai_validation_data.parquet&quot;</span><span class="p">,</span>
                                   <span class="n">dest_path</span><span class="o">=</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;numerai_validation_data.parquet&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">No existing directory found at <span style="color: #008000; text-decoration-color: #008000">'</span><span style="color: #000080; text-decoration-color: #000080">eval_test_1234321</span><span style="color: #008000; text-decoration-color: #008000">'</span>. Creating directory<span style="color: #808000; text-decoration-color: #808000">...</span>
</pre>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">📁 <span style="color: #008000; text-decoration-color: #008000">Downloading</span> <span style="color: #008000; text-decoration-color: #008000">'v3/example_validation_predictions.parquet'</span> 📁
</pre>

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-03-29 12:37:29,552 INFO numerapi.utils: starting download
eval_test_1234321/example_validation_predictions.parquet: 13.0MB [00:02, 6.28MB/s]                            
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">📁 <span style="color: #008000; text-decoration-color: #008000">Downloading</span> <span style="color: #008000; text-decoration-color: #008000">'v3/numerai_validation_data.parquet'</span> 📁
</pre>

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-03-29 12:37:33,329 INFO numerapi.utils: starting download
eval_test_1234321/numerai_validation_data.parquet: 228MB [00:46, 4.85MB/s]                            
</pre>
</div>
</div>

<div class="output_area">




<div id="d5803e91-0183-4165-9e95-be800a3e6314"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d5803e91-0183-4165-9e95-be800a3e6314');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "from numerblox.download import NumeraiClassicDownloader\n\ndirectory = \"eval_test_1234321/\"\ndownloader = NumeraiClassicDownloader(directory_path=directory)\ndownloader.download_single_dataset(filename=\"v3/example_validation_predictions.parquet\",\n                                   dest_path=directory + \"example_validation_predictions.parquet\")\ndownloader.download_single_dataset(filename=\"v3/numerai_validation_data.parquet\",\n                                   dest_path=directory + \"numerai_validation_data.parquet\")";
                var nbb_formatted_code = "from numerblox.download import NumeraiClassicDownloader\n\ndirectory = \"eval_test_1234321/\"\ndownloader = NumeraiClassicDownloader(directory_path=directory)\ndownloader.download_single_dataset(\n    filename=\"v3/example_validation_predictions.parquet\",\n    dest_path=directory + \"example_validation_predictions.parquet\",\n)\ndownloader.download_single_dataset(\n    filename=\"v3/numerai_validation_data.parquet\",\n    dest_path=directory + \"numerai_validation_data.parquet\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
<span class="n">test_dataf</span> <span class="o">=</span> <span class="n">create_numerframe</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;numerai_validation_data.parquet&quot;</span><span class="p">)</span>
<span class="n">example_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;example_validation_predictions.parquet&quot;</span><span class="p">)</span>
<span class="n">test_dataf</span> <span class="o">=</span> <span class="n">test_dataf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">example_preds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

<span class="n">test_dataf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;prediction_random&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataf</span><span class="p">))</span>
<span class="n">test_dataf</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>era</th>
      <th>data_type</th>
      <th>feature_dichasial_hammier_spawner</th>
      <th>feature_rheumy_epistemic_prancer</th>
      <th>feature_pert_performative_hormuz</th>
      <th>feature_hillier_unpitied_theobromine</th>
      <th>feature_perigean_bewitching_thruster</th>
      <th>feature_renegade_undomestic_milord</th>
      <th>feature_koranic_rude_corf</th>
      <th>feature_demisable_expiring_millepede</th>
      <th>...</th>
      <th>target_george_20</th>
      <th>target_george_60</th>
      <th>target_william_20</th>
      <th>target_william_60</th>
      <th>target_arthur_20</th>
      <th>target_arthur_60</th>
      <th>target_thomas_20</th>
      <th>target_thomas_60</th>
      <th>prediction</th>
      <th>prediction_random</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n000777698096000</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.50</td>
      <td>0.50</td>
      <td>0.25</td>
      <td>0.25</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.75</td>
      <td>...</td>
      <td>0.25</td>
      <td>0.5</td>
      <td>0.166667</td>
      <td>0.500000</td>
      <td>0.166667</td>
      <td>0.500000</td>
      <td>0.166667</td>
      <td>0.5</td>
      <td>0.228263</td>
      <td>0.191519</td>
    </tr>
    <tr>
      <th>n0009793a3b91c27</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.75</td>
      <td>0.25</td>
      <td>0.50</td>
      <td>0.75</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>0.25</td>
      <td>...</td>
      <td>0.50</td>
      <td>0.5</td>
      <td>0.666667</td>
      <td>0.833333</td>
      <td>0.666667</td>
      <td>0.833333</td>
      <td>0.500000</td>
      <td>0.5</td>
      <td>0.731198</td>
      <td>0.622109</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 1075 columns</p>
</div>
</div>

</div>

<div class="output_area">




<div id="d57b9472-f578-4423-b632-8751bad93a34"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d57b9472-f578-4423-b632-8751bad93a34');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "np.random.seed(1234)\ntest_dataf = create_numerframe(directory + \"numerai_validation_data.parquet\")\nexample_preds = pd.read_parquet(directory + \"example_validation_predictions.parquet\")\ntest_dataf = test_dataf.merge(example_preds, on=\"id\", how=\"left\")\n\ntest_dataf.loc[:, \"prediction_random\"] = np.random.uniform(size=len(test_dataf))\ntest_dataf.head(2)";
                var nbb_formatted_code = "np.random.seed(1234)\ntest_dataf = create_numerframe(directory + \"numerai_validation_data.parquet\")\nexample_preds = pd.read_parquet(directory + \"example_validation_predictions.parquet\")\ntest_dataf = test_dataf.merge(example_preds, on=\"id\", how=\"left\")\n\ntest_dataf.loc[:, \"prediction_random\"] = np.random.uniform(size=len(test_dataf))\ntest_dataf.head(2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_dataf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>era</th>
      <th>data_type</th>
      <th>feature_dichasial_hammier_spawner</th>
      <th>feature_rheumy_epistemic_prancer</th>
      <th>feature_pert_performative_hormuz</th>
      <th>feature_hillier_unpitied_theobromine</th>
      <th>feature_perigean_bewitching_thruster</th>
      <th>feature_renegade_undomestic_milord</th>
      <th>feature_koranic_rude_corf</th>
      <th>feature_demisable_expiring_millepede</th>
      <th>...</th>
      <th>target_george_20</th>
      <th>target_george_60</th>
      <th>target_william_20</th>
      <th>target_william_60</th>
      <th>target_arthur_20</th>
      <th>target_arthur_60</th>
      <th>target_thomas_20</th>
      <th>target_thomas_60</th>
      <th>prediction</th>
      <th>prediction_random</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n000777698096000</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.50</td>
      <td>0.50</td>
      <td>0.25</td>
      <td>0.25</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.75</td>
      <td>...</td>
      <td>0.25</td>
      <td>0.50</td>
      <td>0.166667</td>
      <td>0.500000</td>
      <td>0.166667</td>
      <td>0.500000</td>
      <td>0.166667</td>
      <td>0.500000</td>
      <td>0.228263</td>
      <td>0.191519</td>
    </tr>
    <tr>
      <th>n0009793a3b91c27</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.75</td>
      <td>0.25</td>
      <td>0.50</td>
      <td>0.75</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.25</td>
      <td>0.25</td>
      <td>...</td>
      <td>0.50</td>
      <td>0.50</td>
      <td>0.666667</td>
      <td>0.833333</td>
      <td>0.666667</td>
      <td>0.833333</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>0.731198</td>
      <td>0.622109</td>
    </tr>
    <tr>
      <th>n00099ccd6698ab0</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.25</td>
      <td>0.75</td>
      <td>0.00</td>
      <td>0.75</td>
      <td>1.00</td>
      <td>0.75</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>...</td>
      <td>0.25</td>
      <td>0.25</td>
      <td>0.166667</td>
      <td>0.333333</td>
      <td>0.166667</td>
      <td>0.333333</td>
      <td>0.166667</td>
      <td>0.166667</td>
      <td>0.846885</td>
      <td>0.437728</td>
    </tr>
    <tr>
      <th>n0019e36bbb8702b</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.50</td>
      <td>1.00</td>
      <td>0.25</td>
      <td>0.75</td>
      <td>0.75</td>
      <td>0.50</td>
      <td>0.00</td>
      <td>0.75</td>
      <td>...</td>
      <td>0.50</td>
      <td>0.50</td>
      <td>0.666667</td>
      <td>0.500000</td>
      <td>0.666667</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>0.849709</td>
      <td>0.785359</td>
    </tr>
    <tr>
      <th>n0028cb874439df8</th>
      <td>0857</td>
      <td>validation</td>
      <td>0.00</td>
      <td>0.75</td>
      <td>0.00</td>
      <td>0.25</td>
      <td>1.00</td>
      <td>0.50</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.50</td>
      <td>0.75</td>
      <td>0.333333</td>
      <td>0.500000</td>
      <td>0.333333</td>
      <td>0.500000</td>
      <td>0.500000</td>
      <td>0.666667</td>
      <td>0.175037</td>
      <td>0.779976</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 1075 columns</p>
</div>
</div>

</div>

<div class="output_area">




<div id="6f9ee323-2cbe-4e42-ab43-e93d25e9fcb5"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6f9ee323-2cbe-4e42-ab43-e93d25e9fcb5');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "test_dataf.head()";
                var nbb_formatted_code = "test_dataf.head()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Full-evaluation">Full evaluation<a class="anchor-link" href="#Full-evaluation"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">NumeraiClassicEvaluator</span><span class="p">()</span>
<span class="n">val_stats</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">full_evaluation</span><span class="p">(</span>
    <span class="n">dataf</span><span class="o">=</span><span class="n">test_dataf</span><span class="p">,</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">pred_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_random&quot;</span><span class="p">],</span>
    <span class="n">example_col</span><span class="o">=</span><span class="s2">&quot;prediction_random&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">val_stats</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-03-29 12:38:30,204 INFO numexpr.utils: Note: NumExpr detected 16 cores but &#34;NUMEXPR_MAX_THREADS&#34; not set, so enforcing safe limit of 8.
2022-03-29 12:38:30,205 INFO numexpr.utils: NumExpr defaulting to 8 threads.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_3472/2276270935.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>     target_col<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;target&#34;</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>     pred_cols<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;prediction&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;prediction_random&#34;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">----&gt; 7</span><span class="ansi-red-fg">     </span>example_col<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;prediction_random&#34;</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> )
<span class="ansi-green-intense-fg ansi-bold">      9</span> val_stats

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_3472/1009285181.py</span> in <span class="ansi-cyan-fg">full_evaluation</span><span class="ansi-blue-fg">(self, dataf, example_col, pred_cols, target_col)</span>
<span class="ansi-green-intense-fg ansi-bold">     28</span>                 pred_col<span class="ansi-blue-fg">=</span>col<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span>                 target_col<span class="ansi-blue-fg">=</span>target_col<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 30</span><span class="ansi-red-fg">                 </span>example_col<span class="ansi-blue-fg">=</span>example_col<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     31</span>             )
<span class="ansi-green-intense-fg ansi-bold">     32</span>             <span class="ansi-red-fg"># Numerai Classic specific metrics</span>

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_3472/981690484.py</span> in <span class="ansi-cyan-fg">evaluation_one_col</span><span class="ansi-blue-fg">(self, dataf, pred_col, target_col, example_col)</span>
<span class="ansi-green-intense-fg ansi-bold">     67</span>         )
<span class="ansi-green-intense-fg ansi-bold">     68</span>         ex_diss = self.exposure_dissimilarity(
<span class="ansi-green-fg">---&gt; 69</span><span class="ansi-red-fg">             </span>dataf<span class="ansi-blue-fg">=</span>dataf<span class="ansi-blue-fg">,</span> pred_col<span class="ansi-blue-fg">=</span>pred_col<span class="ansi-blue-fg">,</span> example_col<span class="ansi-blue-fg">=</span>example_col
<span class="ansi-green-intense-fg ansi-bold">     70</span>         )
<span class="ansi-green-intense-fg ansi-bold">     71</span> 

<span class="ansi-green-fg">/var/folders/d5/1qd2ftjn7ts_5_k6w2k2g4c00000gn/T/ipykernel_3472/981690484.py</span> in <span class="ansi-cyan-fg">exposure_dissimilarity</span><span class="ansi-blue-fg">(self, dataf, pred_col, example_col)</span>
<span class="ansi-green-intense-fg ansi-bold">    248</span>         E <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    249</span>         <span class="ansi-green-fg">for</span> feat <span class="ansi-green-fg">in</span> tqdm<span class="ansi-blue-fg">(</span>dataf<span class="ansi-blue-fg">.</span>feature_cols<span class="ansi-blue-fg">,</span> desc<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;Exposure Dissimilarity correlations&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 250</span><span class="ansi-red-fg">             </span>corr_pred <span class="ansi-blue-fg">=</span> dataf<span class="ansi-blue-fg">[</span>feat<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>corr<span class="ansi-blue-fg">(</span>dataf<span class="ansi-blue-fg">[</span>pred_col<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> method<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;spearman&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    251</span>             corr_example <span class="ansi-blue-fg">=</span> dataf<span class="ansi-blue-fg">[</span>feat<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>corr<span class="ansi-blue-fg">(</span>dataf<span class="ansi-blue-fg">[</span>example_col<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> method<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;spearman&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    252</span>             U<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>corr_pred<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/pandas/core/series.py</span> in <span class="ansi-cyan-fg">corr</span><span class="ansi-blue-fg">(self, other, method, min_periods)</span>
<span class="ansi-green-intense-fg ansi-bold">   2297</span>         <span class="ansi-green-fg">if</span> method <span class="ansi-green-fg">in</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;pearson&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;spearman&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;kendall&#34;</span><span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">or</span> callable<span class="ansi-blue-fg">(</span>method<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   2298</span>             return nanops.nancorr(
<span class="ansi-green-fg">-&gt; 2299</span><span class="ansi-red-fg">                 </span>this<span class="ansi-blue-fg">.</span>values<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">.</span>values<span class="ansi-blue-fg">,</span> method<span class="ansi-blue-fg">=</span>method<span class="ansi-blue-fg">,</span> min_periods<span class="ansi-blue-fg">=</span>min_periods
<span class="ansi-green-intense-fg ansi-bold">   2300</span>             )
<span class="ansi-green-intense-fg ansi-bold">   2301</span> 

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/pandas/core/nanops.py</span> in <span class="ansi-cyan-fg">_f</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     69</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     70</span>                 <span class="ansi-green-fg">with</span> np<span class="ansi-blue-fg">.</span>errstate<span class="ansi-blue-fg">(</span>invalid<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;ignore&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 71</span><span class="ansi-red-fg">                     </span><span class="ansi-green-fg">return</span> f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span>             <span class="ansi-green-fg">except</span> ValueError <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     73</span>                 <span class="ansi-red-fg"># we want to transform an object array</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/pandas/core/nanops.py</span> in <span class="ansi-cyan-fg">nancorr</span><span class="ansi-blue-fg">(a, b, method, min_periods)</span>
<span class="ansi-green-intense-fg ansi-bold">   1457</span> 
<span class="ansi-green-intense-fg ansi-bold">   1458</span>     f <span class="ansi-blue-fg">=</span> get_corr_func<span class="ansi-blue-fg">(</span>method<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1459</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> f<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1460</span> 
<span class="ansi-green-intense-fg ansi-bold">   1461</span> 

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/pandas/core/nanops.py</span> in <span class="ansi-cyan-fg">func</span><span class="ansi-blue-fg">(a, b)</span>
<span class="ansi-green-intense-fg ansi-bold">   1472</span> 
<span class="ansi-green-intense-fg ansi-bold">   1473</span>         <span class="ansi-green-fg">def</span> func<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1474</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> spearmanr<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   1475</span> 
<span class="ansi-green-intense-fg ansi-bold">   1476</span>         <span class="ansi-green-fg">return</span> func

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/scipy/stats/stats.py</span> in <span class="ansi-cyan-fg">spearmanr</span><span class="ansi-blue-fg">(a, b, axis, nan_policy, alternative)</span>
<span class="ansi-green-intense-fg ansi-bold">   4505</span>                 variable_has_nan <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>isnan<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>any<span class="ansi-blue-fg">(</span>axis<span class="ansi-blue-fg">=</span>axisout<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   4506</span> 
<span class="ansi-green-fg">-&gt; 4507</span><span class="ansi-red-fg">     </span>a_ranked <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>apply_along_axis<span class="ansi-blue-fg">(</span>rankdata<span class="ansi-blue-fg">,</span> axisout<span class="ansi-blue-fg">,</span> a<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   4508</span>     rs <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>corrcoef<span class="ansi-blue-fg">(</span>a_ranked<span class="ansi-blue-fg">,</span> rowvar<span class="ansi-blue-fg">=</span>axisout<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   4509</span>     dof <span class="ansi-blue-fg">=</span> n_obs <span class="ansi-blue-fg">-</span> <span class="ansi-cyan-fg">2</span>  <span class="ansi-red-fg"># degrees of freedom</span>

<span class="ansi-green-fg">&lt;__array_function__ internals&gt;</span> in <span class="ansi-cyan-fg">apply_along_axis</span><span class="ansi-blue-fg">(*args, **kwargs)</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/numpy/lib/shape_base.py</span> in <span class="ansi-cyan-fg">apply_along_axis</span><span class="ansi-blue-fg">(func1d, axis, arr, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    400</span>     buff<span class="ansi-blue-fg">[</span>ind0<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> res
<span class="ansi-green-intense-fg ansi-bold">    401</span>     <span class="ansi-green-fg">for</span> ind <span class="ansi-green-fg">in</span> inds<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 402</span><span class="ansi-red-fg">         </span>buff<span class="ansi-blue-fg">[</span>ind<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> asanyarray<span class="ansi-blue-fg">(</span>func1d<span class="ansi-blue-fg">(</span>inarr_view<span class="ansi-blue-fg">[</span>ind<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    403</span> 
<span class="ansi-green-intense-fg ansi-bold">    404</span>     <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> isinstance<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">,</span> matrix<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/scipy/stats/stats.py</span> in <span class="ansi-cyan-fg">rankdata</span><span class="ansi-blue-fg">(a, method, axis)</span>
<span class="ansi-green-intense-fg ansi-bold">   8710</span>     arr <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>ravel<span class="ansi-blue-fg">(</span>np<span class="ansi-blue-fg">.</span>asarray<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   8711</span>     algo <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;mergesort&#39;</span> <span class="ansi-green-fg">if</span> method <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">&#39;ordinal&#39;</span> <span class="ansi-green-fg">else</span> <span class="ansi-blue-fg">&#39;quicksort&#39;</span>
<span class="ansi-green-fg">-&gt; 8712</span><span class="ansi-red-fg">     </span>sorter <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>argsort<span class="ansi-blue-fg">(</span>arr<span class="ansi-blue-fg">,</span> kind<span class="ansi-blue-fg">=</span>algo<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   8713</span> 
<span class="ansi-green-intense-fg ansi-bold">   8714</span>     inv <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>empty<span class="ansi-blue-fg">(</span>sorter<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">,</span> dtype<span class="ansi-blue-fg">=</span>np<span class="ansi-blue-fg">.</span>intp<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;__array_function__ internals&gt;</span> in <span class="ansi-cyan-fg">argsort</span><span class="ansi-blue-fg">(*args, **kwargs)</span>

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/numpy/core/fromnumeric.py</span> in <span class="ansi-cyan-fg">argsort</span><span class="ansi-blue-fg">(a, axis, kind, order)</span>
<span class="ansi-green-intense-fg ansi-bold">   1110</span> 
<span class="ansi-green-intense-fg ansi-bold">   1111</span>     &#34;&#34;&#34;
<span class="ansi-green-fg">-&gt; 1112</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> _wrapfunc<span class="ansi-blue-fg">(</span>a<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;argsort&#39;</span><span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span>axis<span class="ansi-blue-fg">,</span> kind<span class="ansi-blue-fg">=</span>kind<span class="ansi-blue-fg">,</span> order<span class="ansi-blue-fg">=</span>order<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1113</span> 
<span class="ansi-green-intense-fg ansi-bold">   1114</span> 

<span class="ansi-green-fg">/opt/anaconda3/envs/numerai-blocks37/lib/python3.7/site-packages/numpy/core/fromnumeric.py</span> in <span class="ansi-cyan-fg">_wrapfunc</span><span class="ansi-blue-fg">(obj, method, *args, **kwds)</span>
<span class="ansi-green-intense-fg ansi-bold">     56</span> 
<span class="ansi-green-intense-fg ansi-bold">     57</span>     <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 58</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> bound<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwds<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     59</span>     <span class="ansi-green-fg">except</span> TypeError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     60</span>         <span class="ansi-red-fg"># A TypeError occurs if the object does have such a method in its</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

<div class="output_area">




<div id="e84de4b0-55d8-448e-a1e8-bd931f6ec41a"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e84de4b0-55d8-448e-a1e8-bd931f6ec41a');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "# slow\nevaluator = NumeraiClassicEvaluator()\nval_stats = evaluator.full_evaluation(\n    dataf=test_dataf,\n    target_col=\"target\",\n    pred_cols=[\"prediction\", \"prediction_random\"],\n    example_col=\"prediction_random\",\n)\nval_stats";
                var nbb_formatted_code = "# slow\nevaluator = NumeraiClassicEvaluator()\nval_stats = evaluator.full_evaluation(\n    dataf=test_dataf,\n    target_col=\"target\",\n    pred_cols=[\"prediction\", \"prediction_random\"],\n    example_col=\"prediction_random\",\n)\nval_stats";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>Evaluator</code> returns a Pandas DataFrame containing metrics for each prediction column defined.
Note that any column can be used as example prediction. For practical use cases we recommend using proper example predictions (provided by Numerai) instead of random predictions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Fast-evaluation">Fast evaluation<a class="anchor-link" href="#Fast-evaluation"> </a></h4><p><code>fast_mode</code> skips max. feature exposure, feature neutral mean, FNCv3, TB200 and TB500 calculations, which can take a while to compute on full Numerai datasets.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">NumeraiClassicEvaluator</span><span class="p">(</span><span class="n">fast_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_stats_fast</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">full_evaluation</span><span class="p">(</span>
    <span class="n">dataf</span><span class="o">=</span><span class="n">test_dataf</span><span class="p">,</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">pred_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_random&quot;</span><span class="p">],</span>
    <span class="n">example_col</span><span class="o">=</span><span class="s2">&quot;prediction_random&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">val_stats_fast</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Plot-correlations">Plot correlations<a class="anchor-link" href="#Plot-correlations"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>plot_correlations</code> method will use matplotlib to plot per era correlation scores over time. The plots default to a rolling window of 20 eras in order to best align with repuation scores as measured on the Numerai leaderboards.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">evaluator</span><span class="o">.</span><span class="n">plot_correlations</span><span class="p">(</span>
    <span class="n">test_dataf</span><span class="p">,</span> <span class="n">pred_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction_random&quot;</span><span class="p">],</span> <span class="n">roll_mean</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">downloader</span><span class="o">.</span><span class="n">remove_base_directory</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
</div>
 

